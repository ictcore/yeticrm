jQuery.Class("OpenStreetMap_Map_Js",{},{container:false,mapInstance:false,selectedParams:false,layerMarkers:false,markers:false,cacheMarkers:[],polygonLayer:false,routeLayer:false,recordsIds:"",cacheLayerMarkers:{},indirectPointLayer:{},setSelectedParams:function(a){this.selectedParams=a},registerMap:function(c,a){var b=L.map("mapid").setView(c,a);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(b);this.mapInstance=b;return b},setMarkersByResponse:function(h){var q=this;var m=[];var e=this.container;var d=this.mapInstance;if(typeof h.result.coordinates!="undefined"){var i=L.markerClusterGroup({maxClusterRadius:10});var p=h.result.coordinates;d.removeLayer(this.layerMarkers);var f=[];p.forEach(function(s){m.push([s.lat,s.lon]);var r=L.marker([s.lat,s.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:s.color})}).bindPopup(s.label);i.addLayer(r);f.push(s.recordId)});this.recordsIds=f;this.markers=p;this.layerMarkers=i;d.addLayer(i)}d.removeLayer(this.polygonLayer);if(typeof h.result.coordinatesCeneter!="undefined"){if(typeof h.result.coordinatesCeneter.error=="undefined"){var l=e.find(".radius").val();m.push([h.result.coordinatesCeneter.lat,h.result.coordinatesCeneter.lon]);var c='<span class="description">'+e.find(".searchValue").val()+'</span><br /><input type=hidden class="coordinates" data-lon="'+h.result.coordinatesCeneter.lon+'" data-lat="'+h.result.coordinatesCeneter.lat+'">';c+='<button class="btn btn-success btn-xs startTrack marginRight10"><span class="fa fa-truck"></span></button>';c+='<button class="btn btn-danger btn-xs endTrack"><span class="fa fa-flag-checkered"></span></button>';var j=L.marker([h.result.coordinatesCeneter.lat,h.result.coordinatesCeneter.lon],{icon:L.AwesomeMarkers.icon({icon:"search",markerColor:"red",prefix:"fa",})}).bindPopup(c);d.addLayer(j);if($.isNumeric(l)){l=parseInt(l)*1000;var b=L.circle([h.result.coordinatesCeneter.lat,h.result.coordinatesCeneter.lon],l,{color:"red",fillColor:"#f03",fillOpacity:0.05});this.polygonLayer=L.featureGroup([b]);d.addLayer(this.polygonLayer)}}else{var g={title:app.vtranslate("JS_LBL_PERMISSION"),text:h.result.coordinatesCeneter.error,type:"error",animation:"show"};Vtiger_Helper_Js.showMessage(g)}}if(typeof h.result.cache!="undefined"){var a=h.result.cache;Object.keys(a).forEach(function(s){if(typeof q.cacheLayerMarkers[s]!="undefined"){d.removeLayer(q.cacheLayerMarkers[s])}var r=L.markerClusterGroup({maxClusterRadius:10});p=a[s];p.forEach(function(u){if(q.recordsIds.indexOf(u.recordId)===-1){m.push([u.lat,u.lon]);var t=L.marker([u.lat,u.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"orange",prefix:"fa",iconColor:u.color})}).bindPopup(u.label);r.addLayer(t)}});q.cacheMarkers[s]=p;d.addLayer(r);q.cacheLayerMarkers[s]=r})}var o=this.container.find(".modal-footer");if(typeof h.result.legend!="undefined"){var k="";var n=h.result.legend;n.forEach(function(r){k+='<div class="pull-left"><span class="leegendIcon" style="background:'+r.color+'"></span> '+r.value+"</div>"});o.html(k)}else{o.html("")}if(m.length){d.fitBounds(m)}this.container.find(".groupNeighbours").prop("checked",true)},showCalculateBtn:function(){var b=this.container;var a=b.find(".end").val();var c=b.find(".start").val();if(a.length>0&&c.length>0){b.find(".calculateTrack").removeClass("hide")}},registerCacheEvents:function(a){var b=this;a.find(".showRecordsFromCache").on("change",function(f){var d=$(f.currentTarget);var c=d.data("module");if(d.is(":checked")){var g={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),cache:[c],};AppConnector.request(g).then(function(e){b.setMarkersByResponse(e)})}else{b.mapInstance.removeLayer(b.cacheLayerMarkers[c])}});a.find(".copyToClipboard").on("click",function(){var c={module:"OpenStreetMap",action:"ClipBoard",mode:"save",recordIds:JSON.stringify(b.recordsIds),srcModule:app.getModuleName()};AppConnector.request(c).then(function(d){Vtiger_Helper_Js.showMessage({title:app.vtranslate("JS_LBL_PERMISSION"),text:app.vtranslate("JS_NOTIFY_COPY_TEXT"),type:"success",animation:"show"});var e=a.find(".countRecords"+app.getModuleName());e.html(d.result);e.closest(".cacheModuleContainer").find(".deleteClipBoard").removeClass("hide")})});a.find(".deleteClipBoard").on("click",function(f){var d=$(f.currentTarget);var c=d.data("module");var g={module:"OpenStreetMap",action:"ClipBoard",mode:"delete",srcModule:c};AppConnector.request(g).then(function(e){var i={title:app.vtranslate("JS_LBL_PERMISSION"),text:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success",animation:"show"};Vtiger_Helper_Js.showMessage(i);var h=a.find(".countRecords"+c);h.html("");d.addClass("hide");h.closest(".cacheModuleContainer").find(".showRecordsFromCache").prop("checked",false);h.closest(".cacheModuleContainer").find(".showRecordsFromCache").trigger("change")})});a.find(".addAllRecords").on("click",function(f){var d=$(f.currentTarget);var c=d.data("module");var g={module:"OpenStreetMap",action:"ClipBoard",mode:"addAllRecords",srcModule:c};AppConnector.request(g).then(function(e){var i={title:app.vtranslate("JS_LBL_PERMISSION"),text:app.vtranslate("JS_SAVE_NOTIFY_OK"),type:"success",animation:"show"};Vtiger_Helper_Js.showMessage(i);a.find(".countRecords"+c).html(e.result.count);var h=d.closest(".cacheModuleContainer");h.find(".showRecordsFromCache").prop("checked",true);h.find(".showRecordsFromCache").trigger("change");if(e.result.count!="0"){h.find(".deleteClipBoard").removeClass("hide")}})})},getCacheParamsToRequest:function(){var a=this.container;var b=[];a.find(".showRecordsFromCache").each(function(){var c=$(this);if(c.is(":checked")){b.push(c.data("module"))}});return b},registerSearchCompany:function(){var b=this.container;var e=b.find(".searchCompany");var c=b.find(".searchModule");var d=b.find(".addRecord");var a=this;d.on("click",function(){var g=a.mapInstance;var h=a.layerMarkers;var f=d.data("crmId");if(f==""){return false}AppConnector.request({module:"OpenStreetMap",action:"ClipBoard",mode:"addRecord",record:f,srcModuleName:c.val()}).then(function(j){d.data("crmId","");if(j.result.length==1){var i=L.marker([j.result[0].lat,j.result[0].lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"cadetblue",prefix:"fa",iconColor:j.result[0].color})}).bindPopup(j.result[0].label);h.addLayer(i);g.addLayer(h);g.setView(new L.LatLng(j.result[0].lat,j.result[0].lon),14)}else{Vtiger_Helper_Js.showMessage({title:app.vtranslate("JS_LBL_PERMISSION"),text:j.result,type:"error",animation:"show"})}e.val("")})});$.widget("custom.ivAutocomplete",$.ui.autocomplete,{_create:function(){this._super();this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(h,g){var i=this,f="";$.each(g,function(k,l){var j;if(l.category!=f){h.append("<li class='ui-autocomplete-category'>"+l.category+"</li>");f=l.category}i._renderItemData(h,l)})},_renderItemData:function(f,g){return this._renderItem(f,g).data("ui-autocomplete-item",g)},_renderItem:function(f,g){return $("<li>").data("item.autocomplete",g).append($("<a></a>").html(g.label)).appendTo(f)},});e.ivAutocomplete({delay:"600",minLength:"3",source:function(g,f){AppConnector.request({module:app.getModuleName(),view:"BasicAjax",mode:"showSearchResults",value:e.val(),searchModule:c.val(),html:false,}).then(function(i){i=JSON.parse(i);var h=i.result;if(h.length<=0){h.push({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results",category:""})}f(h)})},select:function(g,h){var f=h.item;d.data("crmId",f.id)},close:function(f,g){}})},registerBasicModal:function(){var f=this;var a=this.container;var g=f.mapInstance;var d,e;f.registerCacheEvents(a);a.find(".groupBy").on("click",function(){var h=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var i={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),groupBy:a.find(".fieldsToGroup").val(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val(),cache:f.getCacheParamsToRequest(),};$.extend(i,f.selectedParams);AppConnector.request(i).then(function(j){h.progressIndicator({mode:"hide"});f.setMarkersByResponse(j)})});a.find(".groupNeighbours").on("change",function(j){var i=$(j.currentTarget);g.removeLayer(f.layerMarkers);var k=f.markers;if(i.is(":checked")){d=L.markerClusterGroup({maxClusterRadius:10});k.forEach(function(m){var l=L.marker([m.lat,m.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:m.color})}).bindPopup(m.label);d.addLayer(l)});Object.keys(f.cacheLayerMarkers).forEach(function(l){g.removeLayer(f.cacheLayerMarkers[l]);var m=L.markerClusterGroup({maxClusterRadius:10});f.cacheMarkers[l].forEach(function(o){var n=L.marker([o.lat,o.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"orange",prefix:"fa",iconColor:o.color})}).bindPopup(o.label);m.addLayer(n)});f.cacheLayerMarkers[l]=m;g.addLayer(m)})}else{var h=[];k.forEach(function(m){var l=L.marker([m.lat,m.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:m.color})}).bindPopup(m.label);h.push(l)});d=L.featureGroup(h);Object.keys(f.cacheLayerMarkers).forEach(function(l){g.removeLayer(f.cacheLayerMarkers[l]);var m=[];f.cacheMarkers[l].forEach(function(o){var n=L.marker([o.lat,o.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"orange",prefix:"fa",iconColor:o.color})}).bindPopup(o.label);m.push(n)});f.cacheLayerMarkers[l]=L.featureGroup(m);g.addLayer(f.cacheLayerMarkers[l])})}f.layerMarkers=d;g.addLayer(d)});a.find(".searchBtn").on("click",function(i){var h=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var j={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val(),cache:f.getCacheParamsToRequest(),};$.extend(j,f.selectedParams);AppConnector.request(j).then(function(k){h.progressIndicator({mode:"hide"});f.setMarkersByResponse(k)})});var b=false;a.on("click",".startTrack",function(l){g.removeLayer(b);var k=$(l.currentTarget);var i=k.closest(".leaflet-popup-content");e=i.find(".description").html();var j=a.find(".start");var m=i.find(".coordinates");e=e.replace(/\<br\>/gi,", ");j.val(e);j.data("lat",m.data("lat"));j.data("lon",m.data("lon"));var h=L.marker([m.data("lat"),m.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"truck",markerColor:"green",prefix:"fa",})}).bindPopup(i.html());b=L.featureGroup([h]);g.addLayer(b);f.showCalculateBtn()});var c=false;a.on("click",".endTrack",function(l){g.removeLayer(c);var k=$(l.currentTarget);var i=k.closest(".leaflet-popup-content");e=i.find(".description").html();var j=a.find(".end");var m=i.find(".coordinates");e=e.replace(/\<br\>/gi,", ");j.val(e);j.data("lat",m.data("lat"));j.data("lon",m.data("lon"));var h=L.marker([m.data("lat"),m.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"flag-checkered",markerColor:"red",prefix:"fa",})}).bindPopup(i.html());c=L.featureGroup([h]);g.addLayer(c);f.showCalculateBtn()});a.on("click",".indirectPoint",function(n){var m=$(n.currentTarget);var j=m.closest(".leaflet-popup-content");e=j.find(".description").html();var k=a.find(".indirectTemplate");var l=k.clone();k.before(l);l.removeClass("indirectTemplate");l.removeClass("hide");var o=j.find(".coordinates");e=e.replace(/\<br\>/gi,", ");if(typeof f.indirectPointLayer[e]!="undefined"){g.removeLayer(f.indirectPointLayer[e])}var i=l.find(".indirect");i.val(e);i.data("lat",o.data("lat"));i.data("lon",o.data("lon"));var h=L.marker([o.data("lat"),o.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"flag",markerColor:"orange",prefix:"fa",})}).bindPopup(j.html());f.indirectPointLayer[e]=L.featureGroup([h]);g.addLayer(f.indirectPointLayer[e])});a.on("click",".removeIndirect",function(j){var i=$(j.currentTarget);var h=i.closest(".indirectContainer");g.removeLayer(f.indirectPointLayer[h.find(".indirect").val()]);i.closest(".indirectContainer").remove()});a.on("click",".moveUp",function(k){var j=$(k.currentTarget);var h=j.closest(".indirectContainer");var i=h.prev();if(!i.hasClass("startContainer")){i.before(h)}});a.on("click",".moveDown",function(k){var j=$(k.currentTarget);var h=j.closest(".indirectContainer");var i=h.next();if(!i.hasClass("indirectTemplate")){i.after(h)}});a.on("click",".searchInRadius",function(k){g.removeLayer(c);var j=$(k.currentTarget);var h=j.closest(".leaflet-popup-content");var m=h.find(".coordinates");var i=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var l={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),radius:a.find(".radius").val(),lat:m.data("lat"),lon:m.data("lon"),cache:f.getCacheParamsToRequest(),};$.extend(l,f.selectedParams);AppConnector.request(l).then(function(n){i.progressIndicator({mode:"hide"});f.setMarkersByResponse(n)})});a.find(".calculateTrack").on("click",function(){var i=[];var h=[];a.find(".indirectContainer:not(.hide) input.indirect").each(function(){var n=$(this);h.push(n.data("lat"));i.push(n.data("lon"))});var j=a.find(".end");var k=a.find(".start");var l=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var m={url:"index.php",data:{module:"OpenStreetMap",action:"GetRoute",flon:k.data("lon"),flat:k.data("lat"),ilon:i,ilat:h,tlon:j.data("lon"),tlat:j.data("lat")}};AppConnector.request(m).then(function(o){l.progressIndicator({mode:"hide"});g.removeLayer(f.routeLayer);var n=L.geoJson(o.result);f.routeLayer=L.featureGroup([n]);g.addLayer(f.routeLayer);a.find(".descriptionContainer").removeClass("hide");a.find(".descriptionContent .instruction").html(o.result.properties.description);a.find(".descriptionContent .distance").html(app.parseNumberToShow(o.result.properties.distance));a.find(".descriptionContent .travelTime").html(app.parseNumberToShow(o.result.properties.traveltime/60))})});a.find(".setView").on("click",function(j){var i=$(j.currentTarget);var l=i.closest(".input-group").find(".end,.start");var h=l.data("lat");var k=l.data("lon");if(!(typeof h=="undefined"&&typeof k=="undefined")){g.setView(new L.LatLng(h,k),14)}});this.registerSearchCompany()},registerModalView:function(a){var d=this;var e=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var c=$("body").height();this.container=a;var g=[0,0];var b=2;$("#mapid").css({height:c-200});this.registerMap(g,b);var f={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),};$.extend(f,this.selectedParams);d.registerBasicModal();AppConnector.request(f).then(function(h){e.progressIndicator({mode:"hide"});d.setMarkersByResponse(h)})},registerDetailView:function(a){this.container=a;var f=a.find("#coordinates").val();f=JSON.parse(f);var h=[0,0];var b=2;if(f.length){h=f[0];b=6}var g=$("#mapid").position();var c=$(".footerContainer ").position();$("#mapid").css({height:c.top-g.top-281});var e=this.registerMap(h,b);var d=L.markerClusterGroup({maxClusterRadius:10});f.forEach(function(j){var i=L.marker([j.lat,j.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:j.color})}).bindPopup(j.label);d.addLayer(i)});e.addLayer(d)}});