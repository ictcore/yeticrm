
jQuery.Class("Settings_PickListDependency_Js",{pickListDependencyInstance:false,triggerAdd:function(b){b.stopPropagation();var a=Settings_PickListDependency_Js.pickListDependencyInstance;a.updatedSourceValues=[];a.showEditView(a.listViewForModule).then(function(c){a.registerAddViewEvents()})},triggerEdit:function(d,b,c,e){d.stopPropagation();var a=Settings_PickListDependency_Js.pickListDependencyInstance;a.updatedSourceValues=[];a.showEditView(b,c,e).then(function(h){var g=jQuery("#pickListDependencyForm");g.find('select[name="sourceModule"],select[name="sourceField"],select[name="targetField"]').prop("disabled",true);var f=g.find(".dependencyMapping");app.showHorizontalScrollBar(f);a.registerDependencyGraphEvents();a.registerSubmitEvent()})},triggerDelete:function(f,c,d,g){f.stopPropagation();var h=jQuery(f.currentTarget);var b=h.closest("tr");var a=Settings_PickListDependency_Js.pickListDependencyInstance;var e=app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE");Vtiger_Helper_Js.showConfirmationBox({message:e}).then(function(i){a.deleteDependency(c,d,g).then(function(j){var k={};k.text=app.vtranslate("JS_DEPENDENCY_DELETED_SUEESSFULLY");Settings_Vtiger_Index_Js.showMessage(k);b.fadeOut("slow").remove()})},function(i,j){})}},{init:function(){Settings_PickListDependency_Js.pickListDependencyInstance=this},listViewForModule:"",updatedSourceValues:[],valueMapping:[],selectedSourceValues:[],showEditView:function(b,c,d){var a=jQuery.Deferred();var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var f={};f.module=app.getModuleName();f.parent=app.getParentModuleName();f.view="Edit";f.sourceModule=b;f.sourcefield=c;f.targetfield=d;AppConnector.requestPjax(f).then(function(h){e.progressIndicator({mode:"hide"});var g=jQuery(".contentsDiv");g.html(h);app.showSelect2ElementView(g.find("select.select2"),{dropdownCss:{"z-index":0}});a.resolve(h)},function(g){e.progressIndicator({mode:"hide"});a.reject(g)});return a.promise()},getModuleDependencyGraph:function(b){var a=this;b.find('[name="sourceModule"]').on("change",function(){var c=b.find('[name="sourceModule"]').val();a.showEditView(c).then(function(d){a.registerAddViewEvents()})})},registerPicklistFieldsChangeEvent:function(b){var a=this;b.find('[name="sourceField"],[name="targetField"]').on("change",function(){a.checkValuesForDependencyGraph(b)})},checkValuesForDependencyGraph:function(a){var k=this;var j=a.find('[name="sourceField"]');var f=a.find('[name="targetField"]');var b=app.getSelect2ElementFromSelect(j);var h=app.getSelect2ElementFromSelect(f);var i=j.val();var d=f.val();var c=jQuery("#dependencyGraph");if(i!=""&&d!=""){var l=app.vtranslate("JS_SOURCE_AND_TARGET_FIELDS_SHOULD_NOT_BE_SAME");a.find(".errorMessage").addClass("hide");if(i==d){h.validationEngine("showPrompt",l,"error","topLeft",true);c.html("")}else{b.validationEngine("hide");h.validationEngine("hide");var g=a.find('[name="sourceModule"]').val();var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});k.checkCyclicDependency(g,i,d).then(function(n){var m=n.result;if(!m.result){k.addNewDependencyPickList(g,i,d);e.progressIndicator({mode:"hide"})}else{e.progressIndicator({mode:"hide"});a.find(".errorMessage").removeClass("hide");a.find(".cancelAddView").removeClass("hide");c.html("")}},function(m,n){e.progressIndicator({mode:"hide"})})}}else{a.find(".errorMessage").addClass("hide");var l=app.vtranslate("JS_SELECT_SOME_VALUE");if(i==""){b.validationEngine("showPrompt",l,"error","topLeft",true)}else{if(d==""){h.validationEngine("showPrompt",l,"error","topLeft",true)}}}},checkCyclicDependency:function(a,e,d){var b=jQuery.Deferred();var c={};c.mode="checkCyclicDependency";c.module=app.getModuleName();c.parent=app.getParentModuleName();c.action="Index";c.sourceModule=a;c.sourcefield=e;c.targetfield=d;AppConnector.request(c).then(function(f){b.resolve(f)},function(f,g){b.reject()});return b.promise()},addNewDependencyPickList:function(a,e,d){var b=this;b.updatedSourceValues=[];var c={};c.mode="getDependencyGraph";c.module=app.getModuleName();c.parent=app.getParentModuleName();c.view="IndexAjax";c.sourceModule=a;c.sourcefield=e;c.targetfield=d;AppConnector.request(c).then(function(g){var h=jQuery("#dependencyGraph");h.html(g).css({padding:"10px",border:"1px solid #ddd",background:"#fff"});var f=h.find(".dependencyMapping");app.showHorizontalScrollBar(f);b.registerDependencyGraphEvents()},function(f,g){})},deleteDependency:function(b,c,d){var a=jQuery.Deferred();var e={};e.module=app.getModuleName();e.parent=app.getParentModuleName();e.action="DeleteAjax";e.sourceModule=b;e.sourcefield=c;e.targetfield=d;AppConnector.request(e).then(function(f){a.resolve(f)},function(f,g){a.reject()});return a.promise()},registerCancelAddView:function(c){var b=this;var a=c.find(".cancelAddView");a.removeClass("hide");a.find(".cancelLink").click(function(){b.loadListViewContents(b.listViewForModule)})},registerAddViewEvents:function(){var b=this;var a=jQuery("#pickListDependencyForm");b.registerCancelAddView(a);b.getModuleDependencyGraph(a);b.registerPicklistFieldsChangeEvent(a);b.registerSubmitEvent()},registerDependencyGraphEvents:function(){var b=this;var a=jQuery("#pickListDependencyForm");var c=jQuery("#dependencyGraph");a.find(".cancelAddView").addClass("hide");b.registerTargetFieldsClickEvent(c);b.registerTargetFieldsUnmarkAll(c);b.registerSelectSourceValuesClick(c);b.registerCancelDependency(a)},registerListViewEvents:function(){var b=this;var a=jQuery(".contentsDiv").find(".pickListSupportedModules").val();b.listViewForModule=a;b.registerSourceModuleChangeEvent()},registerCancelDependency:function(c){var b=this;var a=c.find(".cancelDependency");a.click(function(){b.loadListViewContents(b.listViewForModule)})},registerTargetFieldsClickEvent:function(b){var a=this;a.updatedSourceValues=[];b.find("td.picklistValueMapping").on("click",function(f){var d=jQuery(f.currentTarget);var c=d.data("sourceValue");if(jQuery.inArray(c,a.updatedSourceValues)==-1){a.updatedSourceValues.push(c)}if(d.hasClass("selectedCell")){d.addClass("unselectedCell").removeClass("selectedCell").find("i.glyphicon-ok").remove()}else{d.addClass("selectedCell").removeClass("unselectedCell").prepend('<i class="glyphicon glyphicon-ok pull-left"></i>')}})},registerTargetFieldsUnmarkAll:function(b){var a=this;a.updatedSourceValues=[];b.find(".unmarkAll").on("click",function(c){b.find("td.picklistValueMapping").each(function(d){var f=jQuery(this);var e=f.data("sourceValue");if(jQuery.inArray(e,a.updatedSourceValues)==-1){a.updatedSourceValues.push(e)}f.addClass("unselectedCell").removeClass("selectedCell").find("i.glyphicon-ok").remove()})})},updateValueMapping:function(g){var c=this;c.valueMapping=[];var h=c.updatedSourceValues;var f=g.find(".pickListDependencyTable");for(var b in h){if(typeof h[b]=="string"){var e=h[b].replace(/"/g,'\\"')}else{e=h[b]}var d=f.find('td[data-source-value="'+e+'"]').filter(".selectedCell");var a=[];if(d.length>0){jQuery.each(d,function(i,j){a.push(jQuery(j).data("targetValue"))})}else{a.push("")}c.valueMapping.push({sourcevalue:h[b],targetvalues:a})}},registerSelectSourceValuesClick:function(b){var a=this;b.find("button.sourceValues").click(function(){var e=b.find(".modalCloneCopy");var c=e.clone(true,true).removeClass("modalCloneCopy");var d=function(f){f.find(".sourcePicklistValuesModal").removeClass("hide");f.find('[name="saveButton"]').click(function(g){a.selectedSourceValues=[];var h=f.find(".sourceValue");jQuery.each(h,function(j,n){var k=jQuery(n);var m=k.val();var i;if(typeof m=="string"){i=m.replace(/"/g,'\\"')}else{i=m}var l=e.find('[type="checkbox"].sourceValue.'+i);if(k.is(":checked")){a.selectedSourceValues.push(m);l.prop("checked",true)}else{l.prop("checked",false)}});app.hideModalWindow();a.loadMappingForSelectedValues(b)})};app.showModalWindow(c,function(f){if(typeof d=="function"){d(f)}},{width:"1000px"})})},loadMappingForSelectedValues:function(g){var d=this;var c=jQuery.parseJSON(g.find(".allSourceValues").val());var e=g.find(".pickListDependencyTable");for(var b in c){if(typeof c[b]=="string"){var a=c[b].replace(/"/g,'\\"')}else{a=c[b]}var f=e.find('[data-source-value="'+a+'"]');if(jQuery.inArray(c[b],d.selectedSourceValues)==-1){f.hide()}else{f.show()}}g.find(".dependencyMapping").mCustomScrollbar("update")},savePickListDependency:function(b){var a=this;var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var c=b.serializeFormData();c.module=app.getModuleName();c.parent=app.getParentModuleName();c.action="SaveAjax";c.mapping=JSON.stringify(a.valueMapping);AppConnector.request(c).then(function(e){if(e.success){d.progressIndicator({mode:"hide"});var f={};f.text=app.vtranslate("JS_PICKLIST_DEPENDENCY_SAVED");Settings_Vtiger_Index_Js.showMessage(f);a.loadListViewContents(a.listViewForModule)}},function(e){d.progressIndicator({mode:"hide"})})},loadListViewContents:function(a){var b=this;var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var d={};d.module=app.getModuleName();d.parent=app.getParentModuleName();d.view="List";d.formodule=a;AppConnector.requestPjax(d).then(function(e){c.progressIndicator({mode:"hide"});jQuery(".contentsDiv").html(e);app.changeSelectElementView(jQuery(".contentsDiv").find(".pickListSupportedModules"));b.registerListViewEvents()},function(e,f){c.progressIndicator({mode:"hide"})})},triggerDisplayTypeEvent:function(){var a=app.cacheGet("widthType","narrowWidthType");if(a){var b=jQuery(".listViewEntriesTable").find("td,th");b.attr("class",a)}},registerSourceModuleChangeEvent:function(){var b=this;var a=jQuery(".contentsDiv");a.find(".pickListSupportedModules").on("change",function(f){var d=jQuery(f.currentTarget);var c=d.val();b.loadListViewContents(c)})},registerSubmitEvent:function(){var b=this;var a=jQuery("#pickListDependencyForm");var c=jQuery("#dependencyGraph");a.submit(function(d){d.preventDefault();try{b.updateValueMapping(c)}catch(d){bootbox.alert(d.message);return}if(a.find(".editDependency").val()!="true"&&b.valueMapping.length<1){var f={};f.text=app.vtranslate("JS_PICKLIST_DEPENDENCY_NO_SAVED");f.type="info";Settings_Vtiger_Index_Js.showMessage(f)}else{b.savePickListDependency(a)}})},registerEvents:function(){var c=this;var b=jQuery("#pickListDependencyForm");if(b.length>0){var a=b.find(".dependencyMapping");app.showHorizontalScrollBar(a);if(b.find(".editDependency").val()=="true"){b.find('select[name="sourceModule"],select[name="sourceField"],select[name="targetField"]').prop("disabled",true);c.registerDependencyGraphEvents();c.registerSubmitEvent()}else{c.registerAddViewEvents()}}else{c.registerListViewEvents()}}});jQuery(document).ready(function(){var a=new Settings_PickListDependency_Js();a.registerEvents()});