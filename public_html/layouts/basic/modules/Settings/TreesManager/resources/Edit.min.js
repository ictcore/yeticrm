jQuery.Class("Settings_TreesManager_Edit_Js",{},{jstreeInstance:false,jstreeLastID:0,registerEvents:function(){var a=this;var b=$("#EditView");b.validationEngine();var c=a.createTree();$(".addNewElementBtn").click(function(h){var i=$("input.addNewElement");if(i.val()==""){var f=app.vtranslate("JS_FIELD_CAN_NOT_BE_EMPTY");i.validationEngine("showPrompt",f,"error","bottomLeft",true);return false}a.jstreeLastID=a.jstreeLastID+1;var d=c.jstree(true),g=d.get_selected();d.create_node("#",{id:a.jstreeLastID,text:i.val(),},"last");$("input.addNewElement").val("")});$(".saveTree").click(function(f){c.jstree("deselect_all",true);var d=c.jstree("get_json");$("#treeValues").val(JSON.stringify(d));b.submit()});$(".addNewElement").keydown(function(d){if(d.keyCode==13){$(".addNewElementBtn").trigger("click");d.preventDefault();return false}})},createTree:function(){var b=this;if(this.jstreeInstance==false){b.jstreeLastID=parseInt($("#treeLastID").val());var a=$("#treeValues").val();var c=JSON.parse(a);b.jstreeInstance=$("#treeContents");b.jstreeInstance.jstree({core:{data:c,themes:{name:"proton",responsive:true},check_callback:true,},contextmenu:{items:{create:{label:app.vtranslate("JS_JSTREE_CREATE"),action:function(e){var d=$.jstree.reference(e.reference);obj=d.get_node(e.reference);b.jstreeLastID=b.jstreeLastID+1;d.create_node(obj,{id:b.jstreeLastID,text:app.vtranslate("JS_NEW_ITEM")},"last",function(f){setTimeout(function(){d.edit(f)},0)})}},rename:{label:app.vtranslate("JS_JSTREE_RENAME"),action:function(e){var d=$.jstree.reference(e.reference),f=d.get_node(e.reference);d.edit(f)}},changeIcon:{label:app.vtranslate("JS_JSTREE_CHANGE_ICON"),action:function(e){var f=$.jstree.reference(e.reference);var d=f.get_node(e.reference);Settings_Vtiger_Index_Js.selectIcon().then(function(g){b.jstreeInstance.jstree(true).set_icon(d.id,g.name)})}},remove:{label:app.vtranslate("JS_JSTREE_REMOVE"),action:function(f){var e=$.jstree.reference(f.reference);var g=e.get_node(f.reference);var h=e.get_selected();var d=true;$.each(h,function(i,j){var k=e.get_node(j);if(k.children.length>0){Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_YOU_CANNOT_DELETE_PERENT_ITEM"),type:"error"});d=false}});if(d){b.deleteItemEvent(h,e).then(function(i){if(i.length>0){$.each(h,function(j,k){e.delete_node(k)})}})}}},ccp:{label:app.vtranslate("JS_JSTREE_CCP"),submenu:{cut:{label:app.vtranslate("JS_JSTREE_CUT"),action:function(e){var d=$.jstree.reference(e.reference),f=d.get_node(e.reference);if(d.is_selected(f)){d.cut(d.get_top_selected())}else{d.cut(f)}}},paste:{label:app.vtranslate("JS_JSTREE_PASTE"),action:function(e){var d=$.jstree.reference(e.reference),f=d.get_node(e.reference);d.paste(f)}},}}}},plugins:["contextmenu","dnd"]})}return this.jstreeInstance},deleteItemEvent:function(e,d){var b=this;var a=jQuery.Deferred();var c=d.get_json();$.each(e,function(f,g){c=b.checkChildren(g,c)});if(c.length==0){Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_YOU_CANNOT_DELETE_ALL_THE_ITEMS"),type:"error"});a.resolve();return a.promise()}app.showModalWindow(null,"index.php?module=TreesManager&parent=Settings&view=ReplaceTreeItem",function(g){var f=jQuery("form",g);jstreeInstanceReplace=g.find("#treePopupContents");jstreeInstanceReplace.jstree({core:{data:c,themes:{name:"proton",responsive:true},},}).bind("loaded.jstree",function(h,i){$(this).jstree("open_all")});f.submit(function(k){var i=jstreeInstanceReplace.jstree("get_selected");var h=$("#replaceIds").val();if(h==""){var j=[]}else{var j=JSON.parse(h)}if(!i.length){var l={};l.type="error";l.text=app.vtranslate("JS_NO_ITEM_SELECTED");Settings_Vtiger_Index_Js.showMessage(l);return false}else{if(i.length>1){var l={};l.type="error";l.text=app.vtranslate("JS_ONLY_ONE_ITEM_SELECTED");Settings_Vtiger_Index_Js.showMessage(l);return false}}j=$.merge(j,[{old:e,"new":i}]);$("#replaceIds").val(JSON.stringify(j));app.hideModalWindow();a.resolve(i)})});return a.promise()},checkChildren:function(e,c){var b=this;var d=[];for(var a in c){if(c[a].id!=e){if(c[a].children.length){c[a].children=b.checkChildren(e,c[a].children)}d.push(c[a])}}return d}});