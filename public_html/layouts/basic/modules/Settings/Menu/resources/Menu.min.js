jQuery.Class("Settings_Menu_Index_Js",{},{treeInstance:false,loadMenuTree:function(){var a=this;if(a.treeInstance==false){var b=JSON.parse($("#treeValues").val());if(b.length==0){Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_NO_DATA")})}a.treeInstance=$("#treeContent");a.treeInstance.jstree({core:{data:b,check_callback:true,},contextmenu:{items:{rename:{label:app.vtranslate("JS_EDIT"),action:function(e){var d=$.jstree.reference(e.reference);var g=d.get_selected();var f=d.get_node(g);var c=jQuery.progressIndicator();app.showModalWindow(null,"index.php?module=Menu&parent=Settings&view=EditMenu&id="+g,function(h){a.registerEditMenu(h);c.progressIndicator({mode:"hide"})})}},remove:{label:app.vtranslate("JS_REMOVE"),action:function(j){var h=$.jstree.reference(j.reference);var f=h.get_selected();var c=false;for(var e in f){var k=h.get_node(f[e]);if(k.children.length>0){c=true;break}}if(c){var g=$(".modal.deleteAlert").clone(true,true);var d=function(i){i.find(".deleteAlert").removeClass("hide");i.find(".btn-danger").click(function(l){a.removeMenu(f,h)})};app.showModalWindow(g,function(i){if(typeof d=="function"){d(i)}})}else{a.removeMenu(f,h)}}},}},plugins:["contextmenu","dnd","search","state","types"]})}a.registerMenuChanges();return this.treeInstance},registerMenuChanges:function(){var a=this;a.treeInstance.on("move_node.jstree",function(e){var b=jQuery.progressIndicator();var c=a.treeInstance.jstree("get_json");var d=a.getChildrenMenu(c,0);a.save("updateSequence",JSON.stringify(d)).then(function(f){Settings_Vtiger_Index_Js.showMessage({type:"success",text:f.result.message});a.loadContent();b.progressIndicator({mode:"hide"})})})},getChildrenMenu:function(e,a){var d=[];var c=this;var b=$('[name="roleMenu"]').val();$.each(e,function(f,g){var h={i:g.id,s:f,p:a,r:b};if(g.children.length>0){h.c=c.getChildrenMenu(g.children,g.id)}d.push(h)});return d},registerChangeRoleMenu:function(){var a=this;$(".menuConfigContainer").on("change",'[name="roleMenu"]',function(b){a.loadContent()})},getMenuData:function(a){var c=this;var b=jQuery.Deferred();var d={};d.module=app.getModuleName();d.parent=app.getParentModuleName();d.view=app.getViewName();d.roleid=a;AppConnector.requestPjax(d).then(function(e){b.resolve(e)},function(e){b.reject()});return b.promise()},registerAddMenu:function(){var a=this;$(".addMenu").click(function(c){var b=jQuery.progressIndicator();app.showModalWindow(null,"index.php?module=Menu&parent=Settings&view=CreateMenu&mode=step1",function(d){a.registerStep1(d);b.progressIndicator({mode:"hide"})})})},loadContent:function(){var a=jQuery.progressIndicator({position:"#treeContent",blockInfo:{enabled:true}});var b=this;var c=$(".contentsDiv");b.getMenuData($('[name="roleMenu"]').val()).then(function(d){c.html(d);app.showSelect2ElementView(c.find("[name='roleMenu']"));b.registerEvents();a.progressIndicator({mode:"hide"})})},registerEditMenu:function(a){var b=this;a.find("form").validationEngine(app.validationEngineOptions);b.registerHotkeys(a);b.registerHiddenInput(a);b.registerFilters(a);b.registerSelectIcons(a);a.find(".saveButton").click(function(f){var d=a.find("form").serializeFormData();var g=a.find("form").validationEngine("validate");if(g!=false){var c=jQuery.progressIndicator();b.save("updateMenu",d).then(function(e){Settings_Vtiger_Index_Js.showMessage({type:"success",text:e.result.message});app.hideModalWindow();b.loadContent();c.progressIndicator({mode:"hide"})})}});a.find("form").submit(function(c){c.preventDefault()})},registerStep1:function(a){var b=this;a.find(".nextButton").click(function(d){var c=jQuery.progressIndicator();app.showModalWindow(null,"index.php?module=Menu&parent=Settings&view=CreateMenu&mode=step2&mtype="+a.find("select.type").val(),function(e){b.registerStep2(e);c.progressIndicator({mode:"hide"})})})},registerSelectIcons:function(a){var c=a.find("#selectIconButton");var b=a.find('[name="icon"]');c.on("click",function(){$.when(Settings_Vtiger_Index_Js.selectIcon()).then(function(d){b.val(d.name)})})},registerStep2:function(a){var b=this;a.find("form").validationEngine(app.validationEngineOptions);b.registerHotkeys(a);b.registerHiddenInput(a);b.registerFilters(a);b.registerSelectIcons(a);app.showPopoverElementView(jQuery(a).find(".popoverTooltip"));a.find(".saveButton").click(function(f){var d=a.find("form").serializeFormData();d.role=$('[name="roleMenu"]').val();var g=a.find("form").validationEngine("validate");if(g!=false){var c=jQuery.progressIndicator();b.save("createMenu",d).then(function(e){Settings_Vtiger_Index_Js.showMessage({type:"success",text:e.result.message});app.hideModalWindow();b.loadContent();c.progressIndicator({mode:"hide"})})}});a.find("form").submit(function(c){c.preventDefault()})},save:function(e,c){var b=this;var a=jQuery.Deferred();var d={};d.module=app.getModuleName();d.parent=app.getParentModuleName();d.action="SaveAjax";d.mode=e;d.mdata=c;AppConnector.request(d).then(function(f){a.resolve(f)},function(f){a.reject()});return a.promise()},removeMenu:function(c,b){var a=this;a.save("removeMenu",c).then(function(d){Settings_Vtiger_Index_Js.showMessage({type:"success",text:d.result.message});b.delete_node(c);a.loadContent()})},registerHotkeys:function(a){var b=this;a.find(".testBtn").click(function(d){var f=$(this);var c=a.find('[name="hotkey"]').val();Mousetrap.bind(c,function(){Settings_Vtiger_Index_Js.showMessage({type:"success",text:app.vtranslate("JS_TEST_HOTKEY_OK")});f.addClass("btn-success");Mousetrap.unbind(c)})})},registerHiddenInput:function(b){if(b.find("#menuType").val()=="CustomFilter"){var a=b.find('select[name="dataurl"] option:selected').data("tabid");b.find('[name="module"]').val(a);b.on("change",'select[name="dataurl"]',function(d){var c=b.find('select[name="dataurl"] option:selected').data("tabid");b.find('[name="module"]').val(c)})}},cacheFilters:false,registerFilters:function(a){var b=this;if(a.find("#menuType").val()=="Module"){b.cacheFilters=a.find('[name="filters"]').clone(true,true);a.find('[name="module"]').on("change",function(c){b.loadFilters(a,$(this))});b.loadFilters(a,a.find('[name="module"]'))}},loadFilters:function(a,b){var c=this;a.find('[name="filters"]').select2("destroy");a.find('[name="filters"]').html(c.cacheFilters.html());a.find('[name="filters"] option').each(function(d){if($(this).data("tabid")!=b.val()){$(this).remove()}});app.showSelect2ElementView(a.find('[name="filters"]'),{width:"100%"})},registerModalButton:function(){var b=this;var a=jQuery(".menuConfigContainer");a.find(".copyMenu").on("click",function(){var d=a.find(".copyMenuModal").clone(true,true);var c=function(g){var e=g.find("[name='roles']");app.showSelect2ElementView(e);var f=g.find("form");f.submit(function(i){var h=jQuery(i.currentTarget);var j=h.find("#roleList");if(j.length&&j.val()){b.copyMenu(j.val())}i.preventDefault()})};app.showModalWindow(d,function(e){if(typeof c=="function"){c(e)}})})},copyMenu:function(a){var c=this;var b=jQuery.Deferred();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var f=$('[name="roleMenu"]').val();var e={};e.module=app.getModuleName();e.parent=app.getParentModuleName();e.action="SaveAjax";e.mode="copyMenu";e.fromRole=a;e.toRole=f;AppConnector.request(e).then(function(g){app.hideModalWindow();d.progressIndicator({mode:"hide"});c.loadContent();b.resolve(g)},function(g){d.progressIndicator({mode:"hide"});b.reject(g)});return b.promise()},registerEvents:function(){var a=this;a.treeInstance=false;a.loadMenuTree();a.registerChangeRoleMenu();a.registerAddMenu();a.registerModalButton()}});