jQuery.Class("Settings_Sharing_Access_Js",{},{contentTable:false,contentsContainer:false,init:function(){this.setContentTable(".sharingAccessDetails").setContentContainer("#sharingAccessContainer")},setContentTable:function(a){if(a instanceof jQuery){this.contentTable=a;return this}this.contentTable=jQuery(a);return this},setContentContainer:function(a){if(a instanceof jQuery){this.contentsContainer=a;return this}this.contentsContainer=jQuery(a);return this},getContentTable:function(){return this.contentTable},getContentContainer:function(){return this.contentsContainer},getCustomRuleContainerClassName:function(a){return a+"CustomRuleList"},showCustomRulesNextToElement:function(a,d){var c=a.data("moduleName");var b=jQuery('<tr class="'+this.getCustomRuleContainerClassName(c)+'"><td class="customRuleContainer row" colspan="6"></td></tr>');jQuery("td",b).append(d);jQuery(".ruleListContainer",b).css("display","none");a.after(b).addClass("collapseRow");jQuery(".ruleListContainer",b).slideDown("slow")},getCustomRules:function(b){var a=jQuery.Deferred();var c={};c.for_module=b;c.module=app.getModuleName();c.parent=app.getParentModuleName();c.view="IndexAjax";c.mode="showRules";AppConnector.request(c).then(function(d){a.resolve(d)},function(d){a.reject(d)});return a.promise()},save:function(b){var a=jQuery.Deferred();var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});if(typeof b=="undefined"){b={}}AppConnector.request(b).then(function(d){c.progressIndicator({mode:"hide"});a.resolve(d)},function(d,e){c.progressIndicator({mode:"hide"});a.reject(d)});return a.promise()},saveCustomRule:function(b,f){var a=this;var c=b.serializeFormData();if(typeof c=="undefined"){c={}}var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});c.module=app.getModuleName();c.parent=app.getParentModuleName();c.action="IndexAjax";c.mode="saveRule";AppConnector.request(c).then(function(g){d.progressIndicator({mode:"hide"});app.hideModalWindow();a.displaySaveCustomRuleResponse(g);var e=jQuery('[name="for_module"]',b).val();a.loadCustomRulesList(e)})},loadCustomRulesList:function(b){var c=this;var a=this.getContentTable();c.getCustomRules(b).then(function(e){var d=jQuery("."+c.getCustomRuleContainerClassName(b),a);d.find("td.customRuleContainer").html(e)},function(d){})},displaySaveCustomRuleResponse:function(b){var a=this;var d=b.success;var c={};if(d){c={text:app.vtranslate("JS_CUSTOM_RULE_SAVED_SUCCESSFULLY"),type:"success"}}else{c={text:app.vtranslate("JS_CUSTOM_RULE_SAVING_FAILED"),type:"error"}}a.showNotify(c)},showNotify:function(a){var b={text:a.text,type:a.type,width:"30%",delay:"3000"};Vtiger_Helper_Js.showPnotify(b)},editCustomRule:function(a){var b=this;var c=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});app.showModalWindow(null,a,function(d){c.progressIndicator({mode:"hide"});var e=jQuery("#editCustomRule");e.on("submit",function(g){g.preventDefault();var f=jQuery(g.currentTarget);b.saveCustomRule(f,g)})})},deleteCustomRule:function(d){var c=d.data("url");var a=d.closest("tr.customRuleEntries");var b=app.vtranslate("LBL_DELETE_CONFIRMATION");Vtiger_Helper_Js.showConfirmationBox({message:b}).then(function(e){AppConnector.request(c).then(function(g){if(g.success==true){a.fadeOut("slow");var h=a.closest("table .customRuleTable");var f=a.nextAll("tr.customRuleEntries");if(f.length>0){jQuery.each(f,function(l,k){var m=jQuery(k).find(".sequenceNumber");var j=parseInt(m.text())-1;m.text(j)})}a.remove();var i=h.find(".customRuleEntries");if(i.length<1){h.find(".customRuleHeaders").fadeOut("slow").remove();h.parent().find(".recordDetails").removeClass("hide");h.addClass("hide")}}else{Vtiger_Helper_Js.showPnotify(g.error.message)}})},function(e,f){})},registerSharingAccessEdit:function(){var a=this.getContentContainer();a.one("click","input:radio",function(b){a.find("button:submit").removeClass("hide")})},registerDependentModulesPrivilegesChange:function(){var c=this;var a=c.getContentContainer();var b=this.getContentTable();var d=JSON.parse(a.find(".dependentModules").val());jQuery.each(d,function(f,g){var e=b.find('[data-module-name="'+f+'"]').find('[data-action-state="Private"]');e.change(function(j){var i=jQuery(j.currentTarget);if(i.is(":checked")){var h=app.vtranslate("JS_DEPENDENT_PRIVILEGES_SHOULD_CHANGE");bootbox.alert(h);jQuery.each(g,function(k,l){b.find('[data-module-name="'+l+'"]').find('[data-action-state="Private"]').attr("checked","checked")})}})})},registerEvents:function(){var c=this;var a=this.getContentTable();var b=this.getContentContainer();c.registerSharingAccessEdit();c.registerDependentModulesPrivilegesChange();a.on("click","td.triggerCustomSharingAccess",function(i){var g=jQuery(i.currentTarget);var j=g.closest("tr");var d=j.data("moduleName");var f=jQuery("."+c.getCustomRuleContainerClassName(d),a);if(f.length>0){if(app.isHidden(f)){f.show();jQuery(".ruleListContainer",f).slideDown("slow");j.addClass("collapseRow");g.find("button.arrowDown").addClass("hide");g.find("button.arrowUp").removeClass("hide").show()}else{jQuery(".ruleListContainer",f).slideUp("slow",function(k){f.css("display","none")});g.find("button.arrowUp").addClass("hide");g.find("button.arrowDown").removeClass("hide").show();j.removeClass("collapseRow")}return}var h=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});c.getCustomRules(d).then(function(e){h.progressIndicator({mode:"hide"});c.showCustomRulesNextToElement(j,e);g.find("button.arrowDown").addClass("hide");g.find("button.arrowUp").removeClass("hide").show()},function(e){})});a.on("click","button.addCustomRule",function(f){var d=jQuery(f.currentTarget);c.editCustomRule(d.data("url"))});a.on("click",".edit",function(g){var f=jQuery(g.currentTarget);var d=f.data("url");c.editCustomRule(d)});a.on("click",".delete",function(f){var d=jQuery(f.currentTarget);c.deleteCustomRule(d)});b.on("submit","#EditSharingAccess",function(g){g.preventDefault();var d=jQuery(g.currentTarget);var f=d.serializeFormData();c.save(f).then(function(e){b.find("button:submit").addClass("hide");c.registerSharingAccessEdit();var h={text:app.vtranslate("JS_NEW_SHARING_RULES_APPLIED_SUCCESSFULLY"),type:"success"};c.showNotify(h)},function(e,h){})})}});jQuery(document).ready(function(){var a=new Settings_Sharing_Access_Js();a.registerEvents()});