
jQuery.Class("Settings_Widgets_Index_Js",{},{getTabId:function(){return $(".WidgetsManage [name='tabid']").val()},getType:function(){return $(".form-modalAddWidget [name='type']").val()},createStep2:function(b){var c=this;var a=c.getTabId();var d=jQuery.progressIndicator({position:"html"});app.showModalWindow(null,"index.php?parent=Settings&module=Widgets&view=Widget&mode=createStep2&type="+b+"&tabId="+a,function(f){app.showPopoverElementView(f.find(".HelpInfoPopover"));app.showBtnSwitch(f.find(".switchBtn"));if(b=="RelatedModule"){c.loadFilters(f);f.find("select[name='relatedmodule']").change(function(){c.changeRelatedModule()})}d.progressIndicator({mode:"hide"});var e=jQuery("form",f);e.submit(function(i){i.preventDefault();var g=true;if(e&&e.hasClass("validateForm")&&e.data("jqv").InvalidFields.length>0){app.formAlignmentAfterValidation(e);g=false}if(g){var h=e.serializeFormData();c.registerSaveEvent("saveWidget",{data:h,tabid:a,});c.reloadWidgets();app.hideModalWindow()}})})},loadWidgets:function(){var a=this;var b=jQuery(".blocksSortable");b.sortable({revert:true,connectWith:".blocksSortable",tolerance:"pointer",cursor:"move",placeholder:"state-highlight",stop:function(c,d){a.updateSequence()}})},updateSequence:function(){var b=this;var c={};$(".blockSortable").each(function(d){c[$(this).data("id")]={index:d,column:$(this).closest(".blocksSortable").data("column")}});var a=$.progressIndicator({message:app.vtranslate("Saving changes"),blockInfo:{enabled:true}});b.registerSaveEvent("updateSequence",{data:c,tabid:$("input[name='tabid']").val(),});a.progressIndicator({mode:"hide"})},reloadWidgets:function(){var b=this;var a=jQuery.progressIndicator({message:app.vtranslate("Loading data"),position:"html",blockInfo:{enabled:true}});var c={};c.module="Widgets";c.view="Index";c.parent="Settings";c.source=$("input[name='tabid']").val();AppConnector.request(c).then(function(e){var d=jQuery("div.contentsDiv").html(e);b.registerEvents(d);a.progressIndicator({mode:"hide"})})},registerSaveEvent:function(d,a){var c="";var b={};b.data={module:app.getModuleName(),parent:app.getParentModuleName(),action:"SaveAjax",mode:d,params:a};if(d=="saveWidget"){b.async=false}else{b.async=true}b.dataType="json";AppConnector.request(b).done(function(f){var e=f.result;var g={text:e.message,animation:"show",type:"success"};Vtiger_Helper_Js.showPnotify(g);c=e.success},function(f,e){})},loadFilters:function(g){var d=["filter","checkbox","switchHeader"];var f=g.find("select[name='relatedmodule'] option:selected").val();for(var c in d){var e=app.getMainParams(d[c]+"All",true);var a=g.find("select[name='"+d[c]+"']");var b=g.find("input#"+d[c]+"_selected").val();a.empty();a.append($("<option/>",{value:"-",text:app.vtranslate("None")}));if(e[f]!==undefined){a.closest(".form-group").removeClass("hide");$.each(e[f],function(h,j){if(typeof j==="object"){j=j.label}var i={value:h,text:j};if(b==h){i.selected="selected"}a.append($("<option/>",i))});app.showSelect2ElementView(a)}else{a.closest(".form-group").addClass("hide")}}},changeRelatedModule:function(c){var b=this;var a=jQuery(".form-modalAddWidget");b.loadFilters(a)},registerEvents:function(a){var b=this;this.loadWidgets();if(typeof a=="undefined"){a=jQuery(".WidgetsManage")}app.showSelect2ElementView(a.find(".select2"));$(".WidgetsManage select[name='ModulesList']").change(function(d){var c=$(d.currentTarget);$("input[name='tabid']").val(c.val());b.reloadWidgets()});$(".WidgetsManage .addWidget").click(function(f){var d=jQuery.progressIndicator({position:"html"});var c=$(".WidgetsManage select[name='ModulesList']").val();app.showModalWindow(null,"index.php?parent=Settings&module=Widgets&view=Widget&mod="+c,function(g){d.progressIndicator({mode:"hide"});var e=jQuery("form",g);e.submit(function(i){i.preventDefault();var h=e.find('[name="type"]').val();b.createStep2(h)})})});$(".WidgetsManage .editWidget").click(function(f){var d=$(f.currentTarget);var c=d.closest(".blockSortable");app.showModalWindow(null,"index.php?parent=Settings&module=Widgets&view=Widget&mode=edit&id="+c.data("id"),function(g){jQuery("#massEditHeader.modal-title").text(app.vtranslate("JS_EDIT_WIDGET"));app.showBtnSwitch(g.find(".switchBtn"));app.showPopoverElementView(g.find(".HelpInfoPopover"));if(b.getType()=="RelatedModule"){b.loadFilters(g);g.find("select[name='relatedmodule']").change(function(){b.changeRelatedModule()})}var e=jQuery("form",g);e.submit(function(i){i.preventDefault();var h=$.progressIndicator({message:app.vtranslate("Loading data"),blockInfo:{enabled:true}});var j=e.serializeFormData();b.registerSaveEvent("saveWidget",{data:j,tabid:$("input[name='tabid']").val(),});b.reloadWidgets();app.hideModalWindow();h.progressIndicator({mode:"hide"})})})});$(".WidgetsManage .removeWidget").click(function(f){var d=$(f.currentTarget);var c=d.closest(".blockSortable");b.registerSaveEvent("removeWidget",{wid:c.data("id"),});b.reloadWidgets()})}});