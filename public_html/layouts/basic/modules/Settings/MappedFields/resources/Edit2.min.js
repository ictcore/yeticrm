Settings_MappedFields_Edit_Js("Settings_MappedFields_Edit2_Js",{},{step2Container:false,advanceFilterInstance:false,restictName:["__vtrftk","mode","module","parent","record","view"],init:function(){this.initialize()},getContainer:function(){return this.step2Container},setContainer:function(a){this.step2Container=a;return this},initialize:function(a){if(typeof a==="undefined"){a=jQuery("#mf_step2")}if(a.is("#mf_step2")){this.setContainer(a)}else{this.setContainer(jQuery("#mf_step2"))}},submit:function(){var b=jQuery.Deferred();var c=this.getContainer();var d=c.serializeFormData();var a=this.getData(d);a.record=d.record;this.validationMappingFields().then(function(e){if(e){var f=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});app.saveAjax("step2",a).then(function(g){if(g.success==true){Settings_Vtiger_Index_Js.showMessage({text:app.vtranslate("JS_MF_SAVED_SUCCESSFULLY")});var h=jQuery('[name="record"]',c);if(h.val()===""){h.val(g.result.id);d.record=g.result.id}d.record=g.result.id;AppConnector.request(d).then(function(i){c.hide();f.progressIndicator({mode:"hide"});b.resolve(i)},function(i,j){app.errorLog(i,j)})}})}else{b.resolve(false)}});return b.promise()},getData:function(e){var a=[];var c=[];for(var d in e){var b=d.split("][");if(b.length==2){if(b[1]!="default]"&&e[d]!=0){a[d]=e[d]}else{if(b[1]=="default]"){a[d]=jQuery.isArray(e[d])?e[d].join(","):e[d].trim()}}}else{if(b.length!=2&&jQuery.inArray(d,this.restictName)==-1){c[d]=e[d]}}}a=jQuery.extend({},a);c=jQuery.extend({},c);return{mapping:a,otherConditions:JSON.stringify(c)}},registerCancelStepClickEvent:function(a){jQuery("button.cancelLink",a).on("click",function(){window.history.back()})},registerEvents:function(){var a=this.getContainer();var b=app.validationEngineOptions;b.onValidationComplete=function(d,c){return c};b.promptPosition="bottomRight";a.validationEngine(b);app.showSelect2ElementView(a.find(".select2"));this.registerCancelStepClickEvent(a);this.registerEventsForEditView();app.showPopoverElementView(a.find(".popoverTooltip"))},registerEventForAddingNewMapping:function(){var a=this;jQuery("#addMapping").on("click",function(g){var b=jQuery("#mappingToGenerate");var d=b.find("tr:not(.hide)[sequence-number]").last();var f=a.getSequenceNumber(d)+1;var h=jQuery(".newMapping").clone(true,true);h.attr("sequence-number",f);h.find("select.sourceFields.newSelect").attr("name","mapping["+f+"][source]");h.find("select.targetFields.newSelect").attr("name","mapping["+f+"][target]");h.find("input.mappingType").attr("name","mapping["+f+"][type]");h.removeClass("hide newMapping");h.appendTo(b);h.find(".newSelect").removeClass("newSelect").addClass("select2");var c=h.find(".select2");app.showSelect2ElementView(c);jQuery("select.targetFields",h).trigger("change",false);a.loadDefaultValueWidgetForMappedFields(h.find(".select2"))})},getSequenceNumber:function(b){if(b.length){var a=b.attr("sequence-number")}else{a=0}return parseInt(a)},registerOnChangeEventForSourceModule:function(){var b=this;var a=this.getContainer();a.on("change",".sourceFields",function(j){var g=jQuery(j.currentTarget);var c=jQuery(g.closest("tr"));var i=g.val();var f=g.find('option[value="'+i+'"]');var d=f.data("type");var h=f.data("mappingtype");var l=c.find("select.targetFields.select2");var k=a.find(".newMapping").find(".targetFields").children().clone(true,true);var m=jQuery("<div></div>");c.find(".mappingType").val(h);k.each(function(o,p){var n=jQuery(p);if(n.is("option")&&(n.data("type")==d||n.data("type")=="none")){m.append(n)}else{if(n.is("optgroup")&&n.find('[data-type="'+d+'"]').length>0){n.children().each(function(s,e){var r=jQuery(e);if(r.data("type")!=d){r.remove()}});m.append(n)}}});delete k;c.find(".selectedFieldDataType").html(f.data("type-name")?f.data("type-name"):"");l.html(m.children());l.trigger("change",false)})},registerEventToDeleteMapping:function(){var a=this.getContainer();a.on("click",".deleteMapping",function(d){var b=jQuery(d.currentTarget);var c=b.closest("tr");c.remove()})},loadDefaultValueWidget:function(e){var i=this;var b=e.val()+"_defaultvalue";var a=jQuery("#defaultValuesElementsContainer").find("#"+b);var f=e.closest("td").next();var d=f.find("input.default");var h="";if(d.length){h=d.val()}f.children().remove();var g=jQuery("#mappingToGenerate").find("#"+b);if(a.length==0||!e.val()||g.length>0){return}var c=i.getSequenceNumber(e.closest("tr"));var j=a.clone(true,true);j.prop("disabled",false).attr("name","mapping["+c+"][default]");if(j.is(":checkbox")&&h){j.prop("checked",true)}else{if(h){h=typeof j.attr("multiple")!="undefined"?h.split(","):h;j.val(h)}}j.appendTo(f);app.showSelect2ElementView(f.find("select"))},loadDefaultValueWidgetForMappedFields:function(b){var a=this;b.each(function(d,c){a.loadDefaultValueWidget(jQuery(this))});b.on("change",function(d){var c=jQuery(d.currentTarget);a.loadDefaultValueWidget(c)})},registerEventsForEditView:function(){this.registerEventForAddingNewMapping();this.registerOnChangeEventForSourceModule();this.registerEventToDeleteMapping();this.loadDefaultValueWidgetForMappedFields(jQuery("select.targetFields:not(.newSelect)"))},validationMappingFields:function(){var b=jQuery.Deferred();var a=jQuery("#mappingToGenerate tr:not(.hide)");a.each(function(g,k){var d=false;var h=jQuery(this).find(".sourceFields :selected");if(a.find('.sourceFields option[value="'+h.val()+'"]:selected').length>1){var f=jQuery(".sourceModuleName").text();d=f+": "+h.text()}var j=jQuery(this).find(".targetFields :selected");if(a.find('.targetFields option[value="'+j.val()+'"]:selected').length>1){var f=jQuery(".targetModuleName").text();d=f+": "+j.text()}if(d){var c=d+" <br />"+app.vtranslate("JS_IS_ALREADY_BEEN_MAPPED");var l={text:c,type:"error"};Settings_Vtiger_Index_Js.showMessage(l);b.resolve(false);return false}});b.resolve(true);return b.promise()}});