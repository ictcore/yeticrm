
Vtiger_BasicSearch_Js("Vtiger_AdvanceSearch_Js",{cache:{}},{elementContainer:false,advanceFilter:false,filterValidationRegistered:false,filterForm:false,parentContainer:false,getContainer:function(){return this.elementContainer},setContainer:function(a){this.elementContainer=a;return this},getParentContainer:function(){return this.parentContainer},setParentContainer:function(a){this.setMainContainer(a);this.parentContainer=a;return this},getFilterForm:function(){return jQuery('form[name="advanceFilterForm"]',this.getContainer())},getAdvanceSearch:function(){var b=jQuery.Deferred();var c=app.getModuleName();var a=this.getSearchModule();if(a in Vtiger_AdvanceSearch_Js.cache){b.resolve(Vtiger_AdvanceSearch_Js.cache[a]);return b.promise()}if(app.getParentModuleName().length>0){c="Vtiger"}var d={module:c,view:"BasicAjax",mode:"showAdvancedSearch",source_module:a};var e=jQuery.progressIndicator();AppConnector.request(d).then(function(f){e.hide();Vtiger_AdvanceSearch_Js.cache[a]=f;b.resolve(f)},function(f,g){b.reject(f)});return b.promise()},initiateSearch:function(){var b=jQuery.Deferred();var c=this;var a=function(d){c.setContainer(jQuery("#advanceSearchContainer"));c.filterValidationRegistered=false;c.registerEvents();c.advanceFilter=new Vtiger_SearchAdvanceFilter_Js(jQuery(".filterContainer",d));if(jQuery("#searchContainer").height()>200){app.showScrollBar(jQuery("#searchContainer"),{height:"400px",railVisible:"true"})}b.resolve()};c.getAdvanceSearch().then(function(d){var e={};e.data=d;e.cb=a;app.hideModalWindow();app.showModalWindow(e)},function(d){b.reject()});return b.promise()},getNameFields:function(){var a=this.getFilterForm();return a.find('[name="labelFields"]').data("value")},selectBasicSearchValue:function(){var j=this.getParentContainer();if(j==false){return false}var i=j.find(".globalSearchValue").val();if(i.length>0){var b=this.getFilterForm();var c=this.getNameFields();if(typeof c=="undefined"||c==null||c.length==0){return}var f=b.find(".anyConditionContainer");for(var e in c){var h=c[e];if(e!=0){f.find(".addCondition").find("button").trigger("click")}var a=f.find(".conditionList").find(".conditionRow:last");var g=a.find('select[name="columnname"]');g.find('option[data-field-name="'+h+'"]').attr("selected","selected");g.trigger("change").trigger("chosen:updated");var d=a.find('select[name="comparator"]');d.find('option[value="c"]').attr("selected","selected");d.trigger("chosen:updated");var k=a.find('[name="value"]');k.val(i)}}},search:function(){var a=this.advanceFilter.getValues();var b=this.getSearchModule();var c={};c.module=b;c.advfilterlist=JSON.stringify(a);return this._search(c)},showSearchResults:function(f){var e=this;var c=jQuery.Deferred();var b=function(h){c.resolve(h)};var d='<div class="row"><span class="col-md-4 searchHolder"></span><span class="col-md-8 filterHolder marginLeftZero hide"></span></div>';var a=jQuery(d);jQuery(".searchHolder",a).html(f);f=a;var g={};g.data=f;g.cb=b;app.showModalWindow(g);return c.promise()},saveFilter:function(b){var a=jQuery.Deferred();b.source_module=this.getSearchModule();b.status=1;b.advfilterlist=JSON.stringify(this.advanceFilter.getValues(false));b.module="CustomView";b.action="Save";AppConnector.request(b).then(function(c){if(!c.success){var d={title:app.vtranslate("JS_MESSAGE"),text:c.error.message,animation:"show",type:"error"};Vtiger_Helper_Js.showPnotify(d)}a.resolve(c)});return a.promise()},saveAndViewFilter:function(a){this.saveFilter(a).then(function(b){var c=b.result["listviewurl"];window.location.href=c},function(b){})},isSearchAndFilterComponentsShown:function(){var a=jQuery("#globalmodal");var b=jQuery(".filterHolder",a).find("#advanceSearchContainer");if(b.length<=0){return false}return true},performSearch:function(){var a=this;var b=this.isSearchAndFilterComponentsShown();this.search().then(function(c){a.setContainer(a.getContainer().detach());a.showSearchResults(c).then(function(d){a.registerShowFiler();if(b){a.showFilter()}})})},showFilter:function(){var a=this;var b=function(){app.showModalWindow(a.getContainer())};app.hideModalWindow(b)},performValidation:function(){var b=this;this.formValidationDeferred=jQuery.Deferred();var a=this.getFilterForm();var c=function(e,d){if(d){b.formValidationDeferred.resolve()}else{b.formValidationDeferred.reject()}};if(!this.filterValidationRegistered){this.filterValidationRegistered=true;a.validationEngine({onValidationComplete:c})}a.submit();return this.formValidationDeferred.promise()},registerShowFiler:function(){var a=this;jQuery("#showFilter").on("click",function(b){a.showFilter()})},registerEvents:function(){var b=this;var a=this.getContainer();a.on("change","#searchModuleList",function(f){var c=jQuery(f.currentTarget);var d=c.val();b.setSearchModule(d);b.initiateSearch().then(function(){b.selectBasicSearchValue()})});jQuery("#advanceSearchButton").on("click",function(d){var c=b.getSearchModule();if(c.length<=0){app.getChosenElementFromSelect(jQuery("#searchModuleList")).validationEngine("showPrompt",app.vtranslate("JS_SELECT_MODULE"),"error","topRight",true);return}b.performValidation().then(function(){b.performSearch()},function(){})});jQuery("#advanceIntiateSave").on("click",function(f){var c=jQuery(f.currentTarget);c.addClass("hide");var d=c.closest(".actions");jQuery('input[name="viewname"]',d).removeClass("zeroOpacity").focus();jQuery("#advanceSave").removeClass("hide")});jQuery("#advanceSave").on("click",function(h){var d=jQuery(h.currentTarget).closest(".actions");var g=jQuery('input[name="viewname"]',d);var f=g.val();if(f.length<=0){g.validationEngine("showPrompt",app.vtranslate("JS_REQUIRED_FIELD"),"error","topRight",true);return}var c=b.getSearchModule();if(c.length<=0){app.getChosenElementFromSelect(jQuery("#searchModuleList")).validationEngine("showPrompt",app.vtranslate("JS_SELECT_MODULE"),"error","topRight",true);return}b.performValidation().then(function(){var e={};e.viewname=f;b.saveAndViewFilter(e)})});this.getFilterForm().on("submit",function(c){c.preventDefault()});this.setSearchModule(jQuery("#searchModuleList").val())}});