
jQuery.Class("Vtiger_DashBoard_Js",{gridster:false,currentInstance:false,addWidget:function(d,c){d=jQuery(d);var h=d.data("linkid");var b=d.data("name");var g=d.data("id");jQuery(d).parent().remove();if(jQuery("ul.widgetsList li").length<1){jQuery("ul.widgetsList").prev("button").css("visibility","hidden")}var f=jQuery('<li class="new dashboardWidget" id="'+h+"-"+g+'" data-name="'+b+'" data-mode="open"></li>');f.data("url",c);var e=d.data("width");var a=d.data("height");Vtiger_DashBoard_Js.gridster.add_widget(f,e,a);Vtiger_DashBoard_Js.currentInstance.loadWidget(f)},restrictContentDrag:function(a){a.on("mousedown.draggable",function(d){var c=jQuery(d.target);var b=c.closest(".dashboardWidgetHeader").length>0?true:false;if(b){return}d.stopPropagation()})},},{container:false,noCache:false,instancesCache:{},init:function(){Vtiger_DashBoard_Js.currentInstance=this},getContainer:function(){if(this.noCache==true||this.container==false){this.container=jQuery(".gridster ul")}return this.container},getCurrentDashboard:function(){return $(".selectDashboard li.active").data("id")},getWidgetInstance:function(b){var c=b.attr("id");if(this.noCache||!(c in this.instancesCache)){var a=b.data("name");this.instancesCache[c]=Vtiger_Widget_Js.getInstance(b,a)}return this.instancesCache[c]},registerGridster:function(){var a=this;Vtiger_DashBoard_Js.gridster=this.getContainer().gridster({widget_margins:[7,7],widget_base_dimensions:[((a.getContainer().width()/12)-14),100],min_cols:6,min_rows:20,max_size_x:12,draggable:{stop:function(){a.savePositions(jQuery(".dashboardWidget"))}}}).data("gridster")},savePositions:function(d){var c={};for(var b=0,a=d.length;b<a;++b){var e=jQuery(d[b]);c[e.attr("id")]=JSON.stringify({row:e.attr("data-row"),col:e.attr("data-col")})}AppConnector.request({module:"Vtiger",action:"SaveWidgetPositions",positionsmap:c}).then(function(f){})},loadWidgets:function(){var a=this;var b=jQuery(".dashboardWidget");b.each(function(c,d){a.loadWidget(jQuery(d))})},loadWidget:function(f){var e=this;var b=f.data("url");var h=f.data("mode");f.progressIndicator();if(h=="open"){var c=f.data("name");var a=f.data("cache");var d=app.getMainParams("current_user_id");if(a==1){var g=app.cacheGet(c+d,false);b=g?g:b}AppConnector.request(b).then(function(l){f.html(l);app.showSelect2ElementView(f.find(".select2"));e.getWidgetInstance(f);f.trigger(Vtiger_Widget_Js.widgetPostLoadEvent);var j=f.find(".dashboardWidgetHeader").outerHeight();var k=f.height()-j;if(f.find(".dashboardWidgetFooter").length){k-=f.find(".dashboardWidgetFooter").outerHeight()}var i=f.find(".dashboardWidgetContent");i.css("max-height",k+"px");i.css("overflow","auto");i.perfectScrollbar()})}else{}},gridsterStop:function(){var a=Vtiger_DashBoard_Js.gridster},registerRefreshWidget:function(){var a=this;this.getContainer().on("click",'a[name="drefresh"]',function(f){var c=$(f.currentTarget);var d=c.closest("li");var b=a.getWidgetInstance(d);b.refreshWidget();return})},removeWidget:function(){this.getContainer().on("click",'li a[name="dclose"]',function(g){var d=$(g.currentTarget);var a=jQuery(d).parents("li");var c=a.attr("data-sizex");var j=a.attr("data-sizey");var b=d.data("url");var i=d.closest(".dashboardWidgetHeader").parent();var f=i.data("name");var h=i.find(".dashboardTitle").attr("title");var k=app.vtranslate("JS_ARE_YOU_SURE_TO_DELETE_WIDGET")+" ["+h+"]. "+app.vtranslate("JS_ARE_YOU_SURE_TO_DELETE_WIDGET_INFO");Vtiger_Helper_Js.showConfirmationBox({message:k}).then(function(l){AppConnector.request(b).then(function(m){if(m.success){var e=[];i.fadeOut("slow",function(){i.remove()});if(jQuery.inArray(f,e)==-1){Vtiger_DashBoard_Js.gridster.remove_widget(d.closest("li"));jQuery(".widgetsList").prev("button").css("visibility","visible");var o="<li>";if(m.result.deleteFromList){o+="<button ";o+='data-widget-id="'+m.result.id+'" ';o+='class="removeWidgetFromList btn btn-xs btn-danger pull-left" ';o+='style="width:25px;height:25px;margin:2px;" ';o+=">";o+='<span class="glyphicon glyphicon-trash"></span>';o+="</button>"}o+="<a onclick=\"Vtiger_DashBoard_Js.addWidget(this, '"+m.result.url+"')\" ";o+='href="javascript:void(0);" ';o+='class="pull-left" ';o+='data-linkid="'+m.result.linkid+'" ';o+='data-name="'+m.result.name+'" ';o+='data-width="'+c+'" ';o+='data-height="'+j+'" ';o+='style="height:30px;width:100%;margin:0;padding:5px;" ';o+=">";o+=m.result.title+"</a>";o+="</li>";var n=jQuery(".widgetsList .divider");if(n.length){jQuery(o).insertBefore(n)}else{jQuery(".widgetsList").append(o)}}}})},function(e,l){})})},registerSelectDashboard:function(){var a=this;$(".selectDashboard li").on("click",function(f){var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var c=$(f.currentTarget);var b=c.data("id");var g={module:app.getModuleName(),view:app.getViewName(),dashboardId:b};AppConnector.request(g).then(function(e){d.progressIndicator({mode:"hide"});$(".dashboardViewContainer").html(e);a.noCache=true;a.registerEvents()})})},registerDatePickerHideInitiater:function(){var a=this.getContainer();a.on("click","input.dateRange",function(d){var c=jQuery(d.currentTarget).closest(".dashboardWidget");var f=jQuery(".dashboardWidgetHeader",c);var b=function(){var e=jQuery(".dateRange");e.DatePickerHide();e.blur()};Vtiger_Helper_Js.addClickOutSideEvent(f.find(".dateRange"),b);return false})},registerShowMailBody:function(){var a=this.getContainer();a.on("click",".showMailBody",function(f){var d=jQuery(f.currentTarget).closest(".mailRow");var c=d.find(".mailBody");var b=jQuery(f.currentTarget).find(".body-icon");if(c.css("display")=="none"){c.show();b.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up")}else{c.hide();b.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down")}})},registerChangeMailUser:function(){var b=this;var a=this.getContainer();a.on("change","#mailUserList",function(h){var d=$(h.currentTarget);var g=d.closest("li");var f=g.find(".dashboardWidgetContent");var j=$("option:selected",this);var c=g.data("url")+"&user="+j.val();var i={};i.url=c;i.data={};f.progressIndicator({});AppConnector.request(i).then(function(e){f.progressIndicator({mode:"hide"});g.html(e).trigger(Vtiger_Widget_Js.widgetPostRefereshEvent)},function(){f.progressIndicator({mode:"hide"})})})},registerChartFilterWidget:function(){var a=this;$(".dashboardHeading").on("click",".addChartFilter",function(d){var c=$(d.currentTarget);var b=["currency","double","percentage","integer"];app.showModalWindow(null,"index.php?module=Home&view=ChartFilter&step=step1",function(k){var e=jQuery("form",k);e.on("keypress",function(p){return p.keyCode!=13});var g=e.find(".sectorContainer");var i=jQuery('select[name="chartType"]',k);var f=jQuery('select[name="module"]',k);var h=jQuery('select[name="filterid"]',k);var o=jQuery('select[name="groupField"]',k);app.showSelect2ElementView(g.find(".select2"));var n=app.showSelect2ElementView(f,{placeholder:app.vtranslate("JS_SELECT_MODULE")});var j=app.showSelect2ElementView(h,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")});var m=app.showSelect2ElementView(o,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"),closeOnSelect:true,maximumSelectionLength:6});var l=jQuery(".modal-footer",k);h.closest("tr").hide();o.closest("tr").hide();l.hide();i.on("change",function(r){var q=$(r.currentTarget);var p=q.val();if(p=="Barchat"||p=="Horizontal"){e.find(".isColorContainer").removeClass("hide")}else{e.find(".isColorContainer").addClass("hide")}});n.change(function(){if(!n.val()){return}l.hide();o.closest("tr").hide();AppConnector.request({module:"Home",view:"ChartFilter",step:"step2",selectedModule:n.val()}).then(function(p){h.empty().html(p).trigger("change");j.closest("tr").show()})});j.change(function(){if(!j.val()){return}AppConnector.request({module:"Home",view:"ChartFilter",step:"step3",selectedModule:n.val(),filterid:j.val()}).then(function(p){o.empty().html(p).trigger("change");m.closest("tr").show();m.data("select2").$selection.find(".select2-search__field").parent().css("width","100%")})});m.change(function(){if(!m.val()){l.hide()}else{var p=m.find(":selected").data("fieldType");if(i.val()=="Funnel"&&b.indexOf(p)!=-1){g.removeClass("hide")}else{g.addClass("hide")}l.show()}});e.submit(function(t){t.preventDefault();var p=n.val();var w=n.find(":selected").text();var u=j.val();var x=j.find(":selected").text();var s=m.find(":selected").text();var v=0;var q=e.find(".isColor");if(!q.hasClass("hide")&&q.is(":checked")){v=1}var r={module:p,groupField:m.val(),chartType:i.val(),color:v,sector:g.find('[name="sectorField"]').val()};a.saveChartFilterWidget(r,c,w,u,x,s,e)})})})},saveChartFilterWidget:function(d,e,j,c,h,g,b){var i=this;var a={data:JSON.stringify(d),action:"addWidget",blockid:e.data("block-id"),linkid:e.data("linkid"),label:j+" - "+h+" - "+g,name:"ChartFilter",title:b.find('[name="widgetTitle"]').val(),filterid:c,isdefault:0,height:4,width:4,owners_all:["mine","all","users","groups"],default_owner:"mine",dashboardId:i.getCurrentDashboard()};var f=$('[name="selectedModuleName"]').val();i.saveWidget(a,"save",f).then(function(o){var k=o.result;var p={};if(o.success){app.hideModalWindow();a.id=k.id;a.status=k.status;p.text=k.text;p.type="success";var m=e.clone();m.data("name","ChartFilter");m.data("id",k.wid);Vtiger_DashBoard_Js.addWidget(m,"index.php?module=Home&view=ShowWidget&name=ChartFilter&linkid="+e.data("linkid")+"&widgetid="+k.wid+"&active=0");Vtiger_Helper_Js.showMessage(p)}else{var n=o.error["message"];if(o.error["code"]!=513){var l=b.find('[name="fieldName"]')}else{var l=b.find('[name="fieldLabel"]')}l.validationEngine("showPrompt",n,"error","topLeft",true)}})},registerMiniListWidget:function(){var a=this;$(".dashboardHeading").on("click",".addFilter",function(c){var b=$(c.currentTarget);app.showModalWindow(null,"index.php?module=Home&view=MiniListWizard&step=step1",function(h){var d=jQuery("form",h);d.on("keypress",function(m){return m.keyCode!=13});var e=jQuery('select[name="module"]',h);var f=jQuery('select[name="filterid"]',h);var l=jQuery('select[name="fields"]',h);var k=app.showSelect2ElementView(e,{placeholder:app.vtranslate("JS_SELECT_MODULE")});var g=app.showSelect2ElementView(f,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION")});var j=app.showSelect2ElementView(l,{placeholder:app.vtranslate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"),closeOnSelect:true,maximumSelectionLength:6});var i=jQuery(".modal-footer",h);f.closest("tr").hide();l.closest("tr").hide();i.hide();k.change(function(){if(!k.val()){return}i.hide();l.closest("tr").hide();AppConnector.request({module:"Home",view:"MiniListWizard",step:"step2",selectedModule:k.val()}).then(function(m){f.empty().html(m).trigger("change");g.closest("tr").show()})});g.change(function(){if(!g.val()){return}AppConnector.request({module:"Home",view:"MiniListWizard",step:"step3",selectedModule:k.val(),filterid:g.val()}).then(function(m){l.empty().html(m).trigger("change");j.closest("tr").show();j.data("select2").$selection.find(".select2-search__field").parent().css("width","100%")})});j.change(function(){if(!j.val()){i.hide()}else{i.show()}});d.submit(function(s){s.preventDefault();var p=k.val();var o=k.find(":selected").text();var q=g.val();var n=g.find(":selected").text();var m=[];j.select2("data").map(function(t){m.push(t.id)});var r={module:p};if(typeof m!="object"){m=[m]}r.fields=m;a.saveMiniListWidget(r,b,o,q,n,d)})})})},saveMiniListWidget:function(d,e,i,c,g,b){var h=this;var a={data:JSON.stringify(d),action:"addWidget",blockid:e.data("block-id"),linkid:e.data("linkid"),label:i+" - "+g,title:b.find('[name="widgetTitle"]').val(),name:"Mini List",filterid:c,isdefault:0,height:4,width:4,owners_all:["mine","all","users","groups"],default_owner:"mine",dashboardId:h.getCurrentDashboard()};var f=$('[name="selectedModuleName"]').val();h.saveWidget(a,"save",f).then(function(n){var j=n.result;var o={};if(n.success){app.hideModalWindow();a.id=j.id;a.status=j.status;o.text=j.text;o.type="success";var l=e.clone();l.data("name","MiniList");l.data("id",j.wid);Vtiger_DashBoard_Js.addWidget(l,"index.php?module=Home&view=ShowWidget&name=MiniList&linkid="+e.data("linkid")+"&widgetid="+j.wid+"&active=0");Vtiger_Helper_Js.showMessage(o)}else{var m=n.error["message"];if(n.error["code"]!=513){var k=b.find('[name="fieldName"]')}else{var k=b.find('[name="fieldLabel"]')}k.validationEngine("showPrompt",m,"error","topLeft",true)}})},saveWidget:function(c,f,a){var b=jQuery.Deferred();var d=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});if(typeof a=="undefined"){a=app.getModuleName()}var e={form:c,module:"WidgetsManagement",parent:"Settings",sourceModule:a,action:"SaveAjax",mode:f,addToUser:true,};AppConnector.request(e).then(function(g){d.progressIndicator({mode:"hide"});b.resolve(g)},function(g){d.progressIndicator({mode:"hide"});b.reject(g)});return b.promise()},registerTabModules:function(){var a=this;$(".selectDashboradView li").on("click",function(c){var b=$(c.currentTarget);$(".selectDashboradView li").removeClass("active");b.addClass("active");var d={module:b.data("module"),view:app.getViewName(),sourceModule:app.getModuleName(),dashboardId:a.getCurrentDashboard()};AppConnector.request(d).then(function(e){$(".dashboardViewContainer").html(e);a.noCache=true;a.registerEvents()})})},removeWidgetFromList:function(){$(".dashboardHeading").on("click",".removeWidgetFromList",function(b){var a=$(b.currentTarget);var d=a.data("widget-id");var c={module:"Vtiger",action:"RemoveWidgetFromList",id:d};AppConnector.request(c).then(function(f){var g={text:app.vtranslate("JS_WIDGET_DELETED"),type:"success",animation:"show"};Vtiger_Helper_Js.showMessage(g);var e=a.closest("li");$(e).remove()})})},registerEvents:function(){this.registerGridster();this.loadWidgets();this.registerRefreshWidget();this.removeWidget();this.registerDatePickerHideInitiater();this.gridsterStop();this.registerShowMailBody();this.registerChangeMailUser();this.registerMiniListWidget();this.registerChartFilterWidget();this.registerTabModules();this.removeWidgetFromList();this.registerSelectDashboard()}});