
jQuery.Class("Vtiger_Inventory_Js",{},{inventoryContainer:false,inventoryHeadContainer:false,summaryTaxesContainer:false,summaryDiscountContainer:false,summaryCurrenciesContainer:false,rowClass:"tr.inventoryRow",discountModalFields:["aggregationType","globalDiscount","groupCheckbox","groupDiscount","individualDiscount","individualDiscountType"],taxModalFields:["aggregationType","globalTax","groupCheckbox","groupTax","individualTax"],getInventoryItemsContainer:function(){if(this.inventoryContainer===false){this.inventoryContainer=$(".inventoryItems")}return this.inventoryContainer},getInventoryHeadContainer:function(){if(this.inventoryHeadContainer===false){this.inventoryHeadContainer=$(".inventoryHeader")}return this.inventoryHeadContainer},getInventorySummaryDiscountContainer:function(){if(this.summaryDiscountContainer===false){this.summaryDiscountContainer=$(".inventorySummaryDiscounts")}return this.summaryDiscountContainer},getInventorySummaryTaxesContainer:function(){if(this.summaryTaxesContainer===false){this.summaryTaxesContainer=$(".inventorySummaryTaxes")}return this.summaryTaxesContainer},getInventorySummaryCurrenciesContainer:function(){if(this.summaryCurrenciesContainer===false){this.summaryCurrenciesContainer=$(".inventorySummaryCurrencies")}return this.summaryCurrenciesContainer},getNextLineItemRowNumber:function(){var b=$("#inventoryItemsNo");var a=parseInt(b.val());b.val(a+1);return ++a},getAccountId:function(){var a=$("#accountReferenceField").val();if(a!=""){return $('[name="'+a+'"]').val()}return""},checkDeleteIcon:function(){var a=this.getInventoryItemsContainer();if(a.data("isoptional")===1){return}if(a.find(this.rowClass).length>1){this.showLineItemsDeleteIcon()}else{this.hideLineItemsDeleteIcon()}},showLineItemsDeleteIcon:function(){this.getInventoryItemsContainer().find(".deleteRow").removeClass("hide")},hideLineItemsDeleteIcon:function(){this.getInventoryItemsContainer().find(".deleteRow").addClass("hide")},getClosestRow:function(a){return a.closest(this.rowClass)},getBasicRow:function(){return $("#blackIthemTable").find("tbody").clone(true,true)},isRecordSelected:function(a){var b=a.closest("tr");var c=b.find(".recordLabel");return c.validationEngine("validate")},getTaxModeSelectElement:function(b){var a=this.getInventoryHeadContainer();if(a.find("thead .taxMode").length>0){return $(".taxMode")}if(b){return b.find(".taxMode")}else{return false}},isIndividualTaxMode:function(c){var a=this.getTaxModeSelectElement(c);var b=a.find("option:selected");return b.val()=="1"},isGroupTaxMode:function(){var a=this.getTaxModeSelectElement();if(a){var b=a.find("option:selected");if(b.val()=="0"){return true}}return false},showIndividualTax:function(e){var d=this;var c=d.getInventorySummaryTaxesContainer().find(".groupTax");var a=d.getInventoryItemsContainer();var b=$("#blackIthemTable").find("tbody");if(d.isIndividualTaxMode()){c.addClass("hide");a.find(".changeTax").removeClass("hide");b.find(".changeTax").removeClass("hide")}else{c.removeClass("hide");a.find(".changeTax").addClass("hide");b.find(".changeTax").addClass("hide")}d.setTax(a,0);d.setTaxParam(a,[]);d.rowsCalculations()},getDiscountModeSelectElement:function(b){var a=this.getInventoryHeadContainer();if(a.find("thead .discountMode").length>0){return $(".discountMode")}return b.find(".discountMode")},isIndividualDiscountMode:function(c){var a=this.getDiscountModeSelectElement(c);var b=a.find("option:selected");return b.val()=="1"},showIndividualDiscount:function(e){var d=this;var a=d.getInventorySummaryDiscountContainer().find(".groupDiscount");var b=d.getInventoryItemsContainer();var c=$("#blackIthemTable").find("tbody");if(d.isIndividualDiscountMode()){a.addClass("hide");b.find(".changeDiscount").removeClass("hide");c.find(".changeDiscount").removeClass("hide")}else{a.removeClass("hide");b.find(".changeDiscount").addClass("hide");b.find(".changeDiscount").addClass("hide")}d.setDiscount(b,0);d.setDiscountParam(b,[]);d.rowsCalculations()},getCurrency:function(){var a=$('[name="currency"]',this.getInventoryHeadContainer());return a.find("option:selected").val()},getTax:function(a){return $(".tax",a).getNumberFromValue()},getTaxParams:function(a){var b=a.find(".taxParam").val();if(b==""||b=="[]"||b==undefined){return false}return JSON.parse(b)},getQuantityValue:function(a){return $(".qty",a).getNumberFromValue()},getUnitPriceValue:function(a){return $(".unitPrice",a).getNumberFromValue()},getDiscount:function(a){return $(".discount",a).getNumberFromValue()},getNetPrice:function(a){return $(".netPrice",a).getNumberFromValue()},getTotalPrice:function(a){if($(".totalPrice",a).length!=0){return $(".totalPrice",a).getNumberFromValue()}else{return 0}},getGrossPrice:function(a){return $(".grossPrice",a).getNumberFromValue()},getPurchase:function(c){var d=this.getQuantityValue(c);var b=$(".purchase",c);var a=0;if(b.length>0){a=app.parseNumberToFloat(b.val())}return a*d},getSummaryGrossPrice:function(){var b=this;var a=0;this.getInventoryItemsContainer().find(b.rowClass).each(function(c){a+=b.getGrossPrice($(this))});return app.parseNumberToFloat(a)},setUnitPrice:function(b,a){a=app.parseNumberToShow(a);b.find(".unitPrice").val(a).attr("title",a);return this},setNetPrice:function(b,a){a=app.parseNumberToShow(a);$(".netPriceText",b).text(a);$(".netPrice",b).val(a)},setGrossPrice:function(b,a){a=app.parseNumberToShow(a);$(".grossPriceText",b).text(a);$(".grossPrice",b).val(a)},setTotalPrice:function(b,a){a=app.parseNumberToShow(a);$(".totalPriceText",b).text(a);$(".totalPrice",b).val(a)},setMargin:function(b,a){a=app.parseNumberToShow(a);$(".margin",b).val(a)},setMarginP:function(b,a){a=app.parseNumberToShow(a);$(".marginp",b).val(a)},setDiscount:function(b,a){a=app.parseNumberToShow(a);$(".discount",b).val(a)},setDiscountParam:function(b,a){$(".discountParam",b).val(JSON.stringify(a))},setTax:function(b,a){a=app.parseNumberToShow(a);$(".tax",b).val(a)},setTaxParam:function(b,a){$(".taxParam",b).val(JSON.stringify(a))},quantityChangeActions:function(a){this.rowCalculations(a);this.summaryCalculations()},rowCalculations:function(a){this.calculateTotalPrice(a);this.calculateDiscounts(a);this.calculateNetPrice(a);this.calculateTaxes(a);this.calculateGrossPrice(a);this.calculateMargin(a)},rowsCalculations:function(){var a=this;this.getInventoryItemsContainer().find(a.rowClass).each(function(b){a.quantityChangeActions($(this))});a.calculateItemNumbers()},calculateDiscounts:function(f){var e=f.find(".discountParam").val();var a=$(".aggregationTypeDiscount").val();if(e==""||e=="[]"||e==undefined){return 0}e=JSON.parse(e);var c=this.getTotalPrice(f);var d=0;var b=e.aggregationType;if(typeof b=="string"){b=[b]}if(b){b.forEach(function(h){var i;if(h=="individual"){i=e.individualDiscount;var g=e.individualDiscountType;if(g=="percentage"){d+=c*(i/100)}else{d+=app.parseNumberToFloat(i)}}if(h=="global"){d+=c*(app.parseNumberToFloat(e.globalDiscount)/100)}if(h=="group"){d+=c*(app.parseNumberToFloat(e.groupDiscount)/100)}if(a=="2"){c=c-d}})}this.setDiscount(f,d)},calculateTaxes:function(e){var f=e.find(".taxParam").val();if(f==""||f=="[]"||f==undefined){return 0}f=JSON.parse(f);var a=$(".aggregationTypeTax").val();var c=this.getNetPrice(e);var d=0;var b=f.aggregationType;if(typeof b=="string"){b=[b]}if(b){b.forEach(function(h){var g=0;switch(h){case"individual":g=f.individualTax;break;case"global":g=f.globalTax;break;case"group":g=f.groupTax;break;case"regional":g=f.regionalTax;break}d+=c*(app.parseNumberToFloat(g)/100);if(a=="2"){c=c+d}})}this.setTax(e,d)},summaryCalculations:function(){var a=this;a.getInventoryItemsContainer().find("tfoot .wisableTd").each(function(b){a.calculatSummary($(this),$(this).data("sumfield"))});a.calculatDiscountSummary();a.calculatTaxSummary();a.calculatCurrenciesSummary();a.calculatMarginPSummary()},calculatSummary:function(a,d){var c=this;var b=0;this.getInventoryItemsContainer().find(c.rowClass).each(function(e){var f=$(this).find("."+d);if(f.length>0){b+=app.parseNumberToFloat(f.val())}});a.text(app.parseNumberToShow(b))},calculatMarginPSummary:function(){var d=this;var c=d.getInventoryItemsContainer().find("tfoot");var b=app.parseNumberToFloat(c.find('[data-sumfield="purchase"]').text());var e=app.parseNumberToFloat(c.find('[data-sumfield="margin"]').text());e=app.parseNumberToFloat(e);var a="0";if(b!==0){a=(e/b)*100}c.find('[data-sumfield="marginP"]').text(app.parseNumberToShow(a))},calculatDiscountSummary:function(){var b=this;var c=b.getAllDiscount();var a=b.getInventorySummaryDiscountContainer();a.find("input").val(app.parseNumberToShow(c))},getAllDiscount:function(){var a=this;var b=0;this.getInventoryItemsContainer().find(a.rowClass).each(function(c){var d=$(this);b+=a.getDiscount(d)});return b},calculatCurrenciesSummary:function(){var g=this;var a=g.getInventorySummaryCurrenciesContainer();var f=$('[name="currency"] option:selected',g.getInventoryHeadContainer());var h=$('[name="currency"] option[data-base-currency="1"]',g.getInventoryHeadContainer());var b=f.data("conversionRate");var e=h.data("conversionRate");if(b==e){a.addClass("hide");return}b=parseFloat(e)/parseFloat(b);a.removeClass("hide");var c=g.getAllTaxs();var d=0;a.find(".panel-body").html("");$.each(c,function(i,j){if(j!=undefined){j=j*b;var k=a.find(".hide .form-group").clone();k.find(".percent").text(i+"%");k.find("input").val(app.parseNumberToShow(j));k.appendTo(a.find(".panel-body"));d+=j}});a.find(".panel-footer input").val(app.parseNumberToShow(d))},calculatTaxSummary:function(){var e=this;var c=e.getAllTaxs();var a=e.getInventorySummaryTaxesContainer();a.find(".panel-body").html("");var d=0;for(var b in c){var f=a.find(".hide .form-group").clone();f.find(".percent").text(app.parseNumberToShow(app.parseNumberToFloat(b))+"%");f.find("input").val(app.parseNumberToShow(c[b]));f.appendTo(a.find(".panel-body"));d+=c[b]}a.find(".panel-footer input").val(app.parseNumberToShow(d))},getAllTaxs:function(){var b=this;var a=[];var c=$(".aggregationTypeTax").val();this.getInventoryItemsContainer().find(b.rowClass).each(function(d){var g=$(this);var h=b.getNetPrice(g);var f=g.find(".taxParam").val();if(f!=""&&f!="[]"&&f!=undefined){var e=$.parseJSON(f);if(typeof e.aggregationType=="string"){e.aggregationType=[e.aggregationType]}if(e.aggregationType){$.each(e.aggregationType,function(l,k){k=k+"Tax";var j=e[k];var i=0;if(a[j]!=undefined){i=parseFloat(a[j])}var m=h*(app.parseNumberToFloat(j)/100);a[j]=i+m;if(c=="2"){h+=m}})}}});return a},calculateNetPrice:function(a){var b=this.getTotalPrice(a)-this.getDiscount(a);this.setNetPrice(a,b)},calculateGrossPrice:function(a){var b=this.getNetPrice(a);if(this.isIndividualTaxMode(a)||this.isGroupTaxMode(a)){b+=this.getTax(a)}this.setGrossPrice(a,b)},calculateTotalPrice:function(b){var a=this.getQuantityValue(b)*this.getUnitPriceValue(b);this.setTotalPrice(b,a)},calculateMargin:function(d){var e;if(jQuery(".netPrice",d).length){e=this.getNetPrice(d)}else{e=this.getTotalPrice(d)}var b=this.getPurchase(d);var c=e-b;this.setMargin(d,c);var a="0";if(b!==0){a=(c/b)*100}this.setMarginP(d,a)},calculateDiscount:function(j,h){var d=app.parseNumberToFloat(h.find(".valueTotalPrice").text()),b=d,k=0,e=0,f=0,a=0;var i=h.find(".discountsType").val();if(i=="0"||i=="1"){if(h.find(".activepanel .globalDiscount").length>0){k=app.parseNumberToFloat(h.find(".activepanel .globalDiscount").val())}if(h.find(".activepanel .individualDiscountType").length>0){var c=h.find(".activepanel .individualDiscountType:checked").val();var g=app.parseNumberToFloat(h.find(".activepanel .individualDiscountValue").val());if(c=="percentage"){f=d*(g/100)}else{f=g}}if(h.find(".activepanel .groupCheckbox").length>0&&h.find(".activepanel .groupCheckbox").prop("checked")==true){e=app.parseNumberToFloat(h.find(".groupValue").val());e=d*(e/100)}b=b*((100-k)/100);b=b-f;b=b-e}else{if(i=="2"){h.find(".activepanel").each(function(n){var m=$(this);if(m.find(".globalDiscount").length>0){var o=app.parseNumberToFloat(m.find(".globalDiscount").val());b=b*((100-o)/100)}else{if(m.find(".groupCheckbox").length>0&&m.find(".groupCheckbox").prop("checked")==true){var l=app.parseNumberToFloat(m.find(".groupValue").val());b=b*((100-l)/100)}else{if(m.find(".individualDiscountType").length>0){var p=app.parseNumberToFloat(m.find(".individualDiscountValue").val());if(m.find('.individualDiscountType[name="individual"]:checked').val()=="percentage"){b=b*((100-p)/100)}else{b=b-p}}}}})}}h.find(".valuePrices").text(app.parseNumberToShow(b));h.find(".valueDiscount").text(app.parseNumberToShow(d-b))},calculateTax:function(j,i){var f=app.parseNumberToFloat(i.find(".valueNetPrice").text()),b=f,c=0,e=0,a=0,g=0;var d=i.find(".taxsType").val();if(d=="0"||d=="1"){if(i.find(".activepanel .globalTax").length>0){c=app.parseNumberToFloat(i.find(".activepanel .globalTax").val())}if(i.find(".activepanel .individualTaxValue").length>0){var h=app.parseNumberToFloat(i.find(".activepanel .individualTaxValue").val());g=(h/100)*b}if(i.find(".activepanel .groupTax").length>0){e=app.parseNumberToFloat(i.find(".groupTax").val());e=f*(e/100)}if(i.find(".activepanel .regionalTax").length>0){a=app.parseNumberToFloat(i.find(".regionalTax").val());a=f*(a/100)}b=b*((100+c)/100);b=b+g;b=b+e;b=b+a}else{if(d=="2"){i.find(".activepanel").each(function(o){var k=$(this);if(k.find(".globalTax").length>0){var n=app.parseNumberToFloat(k.find(".globalTax").val());b=b*((100+n)/100)}else{if(k.find(".groupTax").length>0){var m=app.parseNumberToFloat(k.find(".groupTax").val());b=b*((100+m)/100)}else{if(k.find(".regionalTax").length>0){var l=app.parseNumberToFloat(k.find(".regionalTax").val());b=b*((100+l)/100)}else{if(k.find(".individualTaxValue").length>0){var p=app.parseNumberToFloat(k.find(".individualTaxValue").val());b=((p+100)/100)*b}}}}})}}i.find(".valuePrices").text(app.parseNumberToShow(b));i.find(".valueTax").text(app.parseNumberToShow(b-f))},updateRowSequence:function(){var a=this.getInventoryItemsContainer();a.find(this.rowClass).each(function(b){$(this).find(".sequence").val(b+1)})},registerInventorySaveData:function(a){var b=this;a.on(Vtiger_Edit_Js.recordPreSave,function(f,d){if(!b.checkLimits(a)){return false}var c=a.find("#blackIthemTable");c.find("[name]").removeAttr("name")})},pricebooksPopupHandler:function(a){var d=this;var c=a.closest(this.rowClass);var b=c.find(".rowName");var e={};e.module="PriceBooks";e.src_module=$('[name="popupReferenceModule"]',b).val();e.src_record=$(".sourceField",b).val();e.src_field=$('[name="popupReferenceModule"]',b).data("field");e.get_url="getProductUnitPriceURL";e.currency_id=d.getCurrency();this.showPopup(e).then(function(g){var f=JSON.parse(g);for(var h in f){if(f[h]){d.setUnitPrice(c,f[h])}else{app.errorLog("Incorrect data",f)}}d.quantityChangeActions(d.getClosestRow(b))})},showPopup:function(c){var a=$.Deferred();var b=Vtiger_Popup_Js.getInstance();b.show(c,function(d){a.resolve(d)});return a.promise()},subProductsCashe:[],loadSubProducts:function(g,a){var d=this;var c=jQuery("input.sourceField",g).val();var e=g.find('.rowName input[name="popupReferenceModule"]').val();d.removeSubProducts(g);if(c=="0"||c==""||$.inArray(e,["Products","Services"])<0){return false}if(d.subProductsCashe[c]){d.addSubProducts(g,d.subProductsCashe[c]);return false}var f={module:"Products",action:"SubProducts",record:c};if(a){var b=jQuery.progressIndicator()}AppConnector.request(f).then(function(i){var h=i.result;d.subProductsCashe[c]=h;d.addSubProducts(g,h);if(b){b.hide()}},function(h,i){if(b){b.hide()}console.error(h,i)})},removeSubProducts:function(a){var b=$(".subProductsContainer ul",a);b.find("li").remove()},addSubProducts:function(c,b){var e=$(".subProductsContainer ul",c);for(var d in b){var a=$("<li>").text(b[d]);e.append(a)}},mapResultsToFields:function(g,b,r){var e,d,a=[];var k=this;var o=k.isGroupTaxMode();for(var l in r){var q=r[l];var m=q.description;var n=q.unitPriceValues;var i=JSON.stringify(n);if(o){var f=b.closest(".inventoryItems").data("taxParam");if(f){a=JSON.parse(f)}}else{if(q.taxes){a={aggregationType:q.taxes.type};a[q.taxes.type+"Tax"]=q.taxes.value}}k.setTaxParam(b,a);k.setTax(b,0);for(var c in q.autoFields){b.find("input."+c).val(q.autoFields[c]);if(q.autoFields[c+"Text"]){b.find("."+c+"Text").text(q.autoFields[c+"Text"])}}var j=k.getCurrency();if(typeof n[j]!=="undefined"){d=n[j]}else{d=q.price}k.setUnitPrice(b,app.parseNumberToFloat(d));$("input.unitPrice",b).attr("list-info",i);var h=$("textarea.commentTextarea",b.next());var p=CKEDITOR.instances[h.attr("id")];if(p){p.setData(m)}else{h.html(m)}if(typeof q.autoFields["unit"]!=="undefined"){$("input.qtyparam",b).prop("checked",false);switch(q.autoFields["unit"]){default:$(".qtyparamButton",b).addClass("hidden");e="validate[required,funcCall[Vtiger_NumberUserFormat_Validator_Js.invokeValidation]]";$("input.qty",b).attr("data-validation-engine",e);break;case"pack":$(".qtyparamButton",b).removeClass("hidden");$(".qtyparamButton",b).removeClass("active");e="validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]";$("input.qty",b).attr("data-validation-engine",e);break;case"pcs":$(".qtyparamButton",b).addClass("hidden");e="validate[required,funcCall[Vtiger_WholeNumber_Validator_Js.invokeValidation]]";$("input.qty",b).attr("data-validation-engine",e);break}}}if(g==="Products"){k.loadSubProducts(b,true)}k.quantityChangeActions(b)},saveDiscountsParameters:function(d,b){var a=this;var c={};var e=["aggregationType","groupCheckbox","individualDiscountType"];$.each(a.discountModalFields,function(f,g){if($.inArray(g,e)>=0){if(b.find('[name="'+g+'"]:checked').length>1){c[g]=[];b.find('[name="'+g+'"]:checked').each(function(h){c[g].push($(this).val())})}else{c[g]=b.find('[name="'+g+'"]:checked').val()}}else{c[g]=b.find('[name="'+g+'"]').val()}});a.setDiscountParam($("#blackIthemTable"),c);a.setDiscountParam(d,c)},saveTaxsParameters:function(d,b){var a=this;var c={};var e=["aggregationType","groupCheckbox","individualTaxType"];$.each(a.taxModalFields,function(f,g){if($.inArray(g,e)>=0){if(b.find('[name="'+g+'"]:checked').length>1){c[g]=[];b.find('[name="'+g+'"]:checked').each(function(h){c[g].push($(this).val())})}else{c[g]=b.find('[name="'+g+'"]:checked').val()}}else{c[g]=b.find('[name="'+g+'"]').val()}});d.data("taxParam",JSON.stringify(c));a.setTaxParam(d,c);a.setTaxParam($("#blackIthemTable"),c)},showExpandedRow:function(f){var e=this;var a=e.getInventoryItemsContainer();var b=a.find('[numrowex="'+f.attr("numrow")+'"]');var c=f.find(".toggleVisibility");c.data("status","1");c.find(".glyphicon").removeClass("glyphicon-menu-down");c.find(".glyphicon").addClass("glyphicon-menu-up");b.removeClass("hide");var d=Vtiger_Edit_Js.getInstance();$.each(b.find(".ckEditorSource"),function(g,h){d.loadCkEditorElement(jQuery(h))})},hideExpandedRow:function(e){var d=this;var a=d.getInventoryItemsContainer();var b=a.find('[numrowex="'+e.attr("numrow")+'"]');var c=e.find(".toggleVisibility");c.data("status","0");c.find(".glyphicon").removeClass("glyphicon-menu-up");c.find(".glyphicon").addClass("glyphicon-menu-down");b.addClass("hide");$.each(b.find(".ckEditorSource"),function(g,h){var f=CKEDITOR.instances[jQuery(h).attr("id")];if(f){f.destroy()}})},initDiscountsParameters:function(d,c){var b=this;var a=d.find(".discountParam").val();if(a==""||a==undefined){return}a=JSON.parse(a);$.each(b.discountModalFields,function(e,g){var i=a[g];var f=c.find('[name="'+g+'"]');if(f.attr("type")=="checkbox"||f.attr("type")=="radio"){var h=i;if(!$.isArray(h)){h=[h]}$.each(h,function(j,k){var l=f.filter('[value="'+k+'"]').prop("checked",true);if(g=="aggregationType"){l.closest(".panel").find(".panel-body").show();l.closest(".panel").addClass("activepanel")}})}else{if(f.prop("tagName")=="SELECT"){f.find('option[value="'+i+'"]').prop("selected","selected").change()}else{c.find('[name="'+g+'"]').val(i)}}});b.calculateDiscount(d,c)},initTaxParameters:function(d,c){var b=this;if(d.data("taxParam")){var a=d.data("taxParam")}else{var a=d.find(".taxParam").val()}if(!a){return}a=JSON.parse(a);$.each(b.taxModalFields,function(e,g){var i=a[g];var f=c.find('[name="'+g+'"]');if(f.attr("type")=="checkbox"||f.attr("type")=="radio"){var h=i;if(!$.isArray(h)){h=[h]}$.each(h,function(j,k){var l=f.filter('[value="'+k+'"]').prop("checked",true);if(g=="aggregationType"){l.closest(".panel").find(".panel-body").show();l.closest(".panel").addClass("activepanel")}})}else{if(f.prop("tagName")=="SELECT"){f.find('option[value="'+i+'"]').prop("selected","selected").change()}else{c.find('[name="'+g+'"]').val(i)}}});b.calculateTax(d,c)},limitEnableSave:false,checkLimits:function(){var d=this;var e=d.getAccountId();var a=parseInt(app.getMainParams("inventoryLimit"));var b=true;if(e==""||d.limitEnableSave||!a){return b}var f={};f.data={module:app.getModuleName(),action:"Inventory",mode:"checkLimits",record:e,currency:d.getCurrency(),price:d.getSummaryGrossPrice()};f.async=false;f.dataType="json";var c=jQuery.progressIndicator();AppConnector.request(f).done(function(g){c.hide();if(g.result.status==false){app.showModalWindow(g.result.html,function(h){});b=false}},function(g,h){c.hide();console.error(g,h)});return b},currencyChangeActions:function(a,b){var c=this;if(b.data("baseCurrency")==0){c.showCurrencyChangeModal(a,b)}else{c.currencyConvertValues(a,b);a.data("oldValue",a.val())}},showCurrencyChangeModal:function(a,b){var d=this;if(d.lockCurrencyChange==true){return}d.lockCurrencyChange=true;var e=a.closest("th");var c=e.find(".modelContainer").clone();app.showModalWindow(c,function(i){var g=$(i);var f=JSON.parse(e.find(".currencyparam").val());if(f!=false){if(typeof f[b.val()]=="undefined"){var h=[];h.value=1;h.date="";f[b.val()]=h}g.find(".currencyName").text(b.text());g.find(".currencyRate").val(f[b.val()]["value"]);g.find(".currencyDate").text(f[b.val()]["date"])}g.on("click",'button[type="submit"]',function(m){var k=g.find(".currencyRate").val();var l=app.parseNumberToFloat(k);var j=1/app.parseNumberToFloat(k);b.data("conversionRate",j);f[b.val()]={value:l.toString(),conversion:j.toString()};e.find(".currencyparam").val(JSON.stringify(f));d.currencyConvertValues(a,b);a.data("oldValue",a.val());app.hideModalWindow();d.lockCurrencyChange=false});g.on("click",'button[type="reset"]',function(j){a.val(a.data("oldValue")).change();d.lockCurrencyChange=false})})},currencyConvertValues:function(a,d){var f=this;var e=a.find('option[value="'+a.data("oldValue")+'"]');var b=d.data("conversionRate");var c=e.data("conversionRate");b=parseFloat(b)/parseFloat(c);this.getInventoryItemsContainer().find(f.rowClass).each(function(g){var h=$(this);f.setUnitPrice(h,app.parseNumberToFloat(f.getUnitPriceValue(h)*b));f.setDiscount(h,app.parseNumberToFloat(f.getDiscount(h)*b));f.setTax(h,app.parseNumberToFloat(f.getTax(h)*b));f.quantityChangeActions(h)})},registerAddItem:function(a){var c=this;var b=this.getInventoryItemsContainer();a.find(".btn-toolbar .addItem").on("click",function(h,f){var l=a.find("#blackIthemTable");var m=c.getBasicRow();var i=c.getNextLineItemRowNumber();var d=$(h.currentTarget).data("module");var j=$(h.currentTarget).data("field");var g=$(h.currentTarget).data("wysiwyg");var k=m.html().replace(/_NUM_/g,i);m.html(k);m=m.find("tr").appendTo(b.find("tbody"));m.find('.rowName input[name="popupReferenceModule"]').val(d).data("field",j);m.find("select").each(function(n,e){e=$(e);e.find("option").each(function(o,p){p=$(p);if(p.data("module")!=d){p.remove()}});app.showSelect2ElementView(e)});c.initItem(m);Vtiger_Edit_Js.getInstance().registerAutoCompleteFields(m)})},registerSortableItems:function(){var b=this;var a=b.getInventoryItemsContainer();a.sortable({handle:".dragHandle",items:b.rowClass,revert:true,tolerance:"pointer",placeholder:"ui-state-highlight",helper:function(d,c){c.children().each(function(e,f){f=$(f);f.width(f.width())});return c},start:function(c,d){a.find(b.rowClass).each(function(e,f){var g=$(f);b.hideExpandedRow(g)});d.item.startPos=d.item.index()},stop:function(d,e){var c=$(e.item.context).attr("numrow");var f=a.find(".numRow"+c).remove().clone();a.find('[numrow="'+c+'"]').after(f);if(e.item.startPos<e.item.index()){f=a.find(".numRow"+c).next().remove().clone();a.find('[numrow="'+c+'"]').before(f)}b.updateRowSequence()}})},registerShowHideExpanded:function(a){var b=this;a.on("click",".toggleVisibility",function(d){var c=$(d.currentTarget);var f=b.getClosestRow(c);if(c.data("status")=="0"){b.showExpandedRow(f)}else{b.hideExpandedRow(f)}})},registerPriceBookPopUp:function(a){var b=this;a.on("click",".priceBookPopup",function(f){var d=$(f.currentTarget);var c=b.isRecordSelected(d);if(c==true){return}b.pricebooksPopupHandler(d)})},registerRowChangeEvent:function(a){var c=this;a.on("focusout",".qty",function(f){var d=$(f.currentTarget);c.quantityChangeActions(c.getClosestRow(d))});a.on("focusout",".unitPrice",function(f){var d=$(f.currentTarget);c.quantityChangeActions(c.getClosestRow(d))});a.on("focusout",".purchase",function(f){var d=$(f.currentTarget);c.quantityChangeActions(c.getClosestRow(d))});var b=c.getInventoryHeadContainer();b.on("change",".taxMode",function(f){var d=$(f.currentTarget);c.showIndividualTax(c.getClosestRow(d));c.rowsCalculations()});b.on("change",".discountMode",function(f){var d=$(f.currentTarget);c.showIndividualDiscount(c.getClosestRow(d));c.rowsCalculations()})},registerSubProducts:function(a){var b=this;a.find(".inventoryItems "+b.rowClass).each(function(c){b.loadSubProducts($(this),false)})},registerClearReferenceSelection:function(a){var b=this;a.on("click",".clearReferenceSelection",function(d){var c=$(d.currentTarget);var f=b.getClosestRow(c);b.removeSubProducts(f);f.find(".unitPrice,.tax,.discount,.margin,.purchase").val(app.parseNumberToShow(0));f.find("textarea,.valueVal").val("");f.find(".valueText").text("");f.find(".qtyparamButton").addClass("hidden");f.find("input.qtyparam").prop("checked",false);if(!b.isGroupTaxMode()){b.setTaxParam(f,[])}b.quantityChangeActions(f)})},registerDeleteLineItemEvent:function(a){var b=this;a.on("click",".deleteRow",function(d){var c=$(d.currentTarget);var f=b.getClosestRow(c);a.find('[numrowex="'+f.attr("numrow")+'"]').remove();f.remove();b.checkDeleteIcon();b.rowsCalculations();if(b.getInventoryItemsContainer().find(".inventoryRow").length===0){$("#inventoryItemsNo").val(0)}})},registerChangeDiscount:function(a){var b=this;a.on("click",".changeDiscount",function(g){var f;var d=$(g.currentTarget);var h={module:app.getModuleName(),view:"Inventory",mode:"showDiscounts",currency:b.getCurrency(),relatedRecord:b.getAccountId()};if(d.hasClass("groupDiscount")){f=b.getInventoryItemsContainer();if(f.find("tfoot .colTotalPrice").length!=0){h.totalPrice=app.parseNumberToFloat(f.find("tfoot .colTotalPrice").text())}else{h.totalPrice=0}h.discountType=1}else{f=d.closest(b.rowClass);h.totalPrice=b.getTotalPrice(f);h.discountType=0}var c=jQuery.progressIndicator();AppConnector.request(h).then(function(e){app.showModalWindow(e,function(i){b.initDiscountsParameters(f,$(i));b.registerChangeDiscountModal(i,f,h)});c.hide()},function(e,i){c.hide();console.error(e,i)})})},registerChangeDiscountModal:function(b,c,d){var a=this;b.on("change",".individualDiscountType",function(g){var f=$(g.currentTarget);b.find(".individualDiscountContainer .input-group-addon").text(f.data("symbol"))});b.on("change",'.activeCheckbox[name="aggregationType"]',function(g){var f=$(g.currentTarget);if(f.attr("type")=="checkbox"&&this.checked){f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{if(f.attr("type")=="radio"){b.find(".panel").removeClass("activepanel");b.find(".panel .panel-body").hide();f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{f.closest(".panel").find(".panel-body").hide();f.closest(".panel").removeClass("activepanel")}}});b.on("change",".activeCheckbox, .globalDiscount,.individualDiscountValue,.individualDiscountType,.groupCheckbox",function(g){var f=$(g.currentTarget);a.calculateDiscount(c,b)});b.on("click",".saveDiscount",function(g){a.saveDiscountsParameters(c,b);if(d.discountType==0){a.setDiscount(c,app.parseNumberToFloat(b.find(".valueDiscount").text()));a.quantityChangeActions(c)}else{var f=app.parseNumberToFloat(b.find(".valueDiscount").text())/app.parseNumberToFloat(b.find(".valueTotalPrice").text());c.find(a.rowClass).each(function(e){a.setDiscount($(this),a.getTotalPrice($(this))*f);a.quantityChangeActions($(this))})}app.hideModalWindow()})},registerChangeTax:function(a){var b=this;a.on("click",".changeTax",function(h){var g;var f=$(h.currentTarget);var i={module:app.getModuleName(),view:"Inventory",mode:"showTaxes",currency:b.getCurrency(),sourceRecord:app.getRecordId()};if(f.hasClass("groupTax")){g=b.getInventoryItemsContainer();var c=0;if(g.find("tfoot .colNetPrice").length>0){c=g.find("tfoot .colNetPrice").text()}else{if(g.find("tfoot .colTotalPrice ").length>0){c=g.find("tfoot .colTotalPrice ").text()}}i.totalPrice=app.parseNumberToFloat(c);i.taxType=1}else{g=f.closest(b.rowClass);i.totalPrice=b.getNetPrice(g);i.taxType=0;i.record=g.find(".rowName .sourceField").val();i.recordModule=g.find('.rowName [name="popupReferenceModule"]').val()}var d=jQuery.progressIndicator();AppConnector.request(i).then(function(e){app.showModalWindow(e,function(j){b.initTaxParameters(g,$(j));b.registerChangeTaxModal(j,g,i)});d.hide()},function(e,j){d.hide();console.error(e,j)})})},lockCurrencyChange:false,registerChangeCurrency:function(a){var b=this;a.on("change",'[name="currency"]',function(f){var c=$(f.currentTarget);var d=c.find("option:selected").data("conversionSymbol");b.currencyChangeActions(c,c.find("option:selected"));a.find(".currencySymbol").text(d)})},registerChangeTaxModal:function(b,c,d){var a=this;b.on("change",".individualTaxType",function(g){var f=$(g.currentTarget);b.find(".individualTaxContainer .input-group-addon").text(f.data("symbol"))});b.on("change",'.activeCheckbox[name="aggregationType"]',function(g){var f=$(g.currentTarget);if(f.attr("type")=="checkbox"&&this.checked){f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{if(f.attr("type")=="radio"){b.find(".panel").removeClass("activepanel");b.find(".panel .panel-body").hide();f.closest(".panel").find(".panel-body").show();f.closest(".panel").addClass("activepanel")}else{f.closest(".panel").find(".panel-body").hide();f.closest(".panel").removeClass("activepanel")}}});b.on("change",".activeCheckbox, .globalTax, .individualTaxValue, .groupTax, .regionalTax",function(f){a.calculateTax(c,b)});b.on("click",".saveTaxs",function(g){a.saveTaxsParameters(c,b);if(d.taxType=="0"){a.setTax(c,app.parseNumberToFloat(b.find(".valueTax").text()));a.quantityChangeActions(c)}else{var f=app.parseNumberToFloat(b.find(".valueTax").text())/app.parseNumberToFloat(b.find(".valueNetPrice").text());c.find(a.rowClass).each(function(h){var e;if($(".netPrice",$(this)).length>0){e=a.getNetPrice($(this))}else{if($(".totalPrice",$(this)).length>0){e=a.getTotalPrice($(this))}}a.setTax($(this),e*f);a.quantityChangeActions($(this))})}app.hideModalWindow()})},registerRowAutoComplete:function(a){var b=this;var c=a.find(".sourceField");c.on(Vtiger_Edit_Js.referenceSelectionEvent,function(j,k){var d=k.record;var g=$(j.currentTarget);var i=g.closest(b.rowClass);var f=i.find('.rowName [name="popupReferenceModule"]').val();var h="index.php?module="+app.getModuleName()+"&action=Inventory&mode=getDetails&record="+d+"&currency_id="+b.getCurrency()+"&fieldname="+g.data("columnname");AppConnector.request(h).then(function(l){for(var m in l){if(typeof l[m]=="object"){var e=l[m];b.mapResultsToFields(f,i,e)}}})})},calculateItemNumbers:function(){var c=this;var a=this.getInventoryItemsContainer();var b=1;a.find(c.rowClass).each(function(d){$(this).find(".itemNumberText").text(b);b++})},initItem:function(a){var b=this;if(typeof a=="undefined"){a=b.getInventoryItemsContainer()}b.registerDeleteLineItemEvent(a);b.registerPriceBookPopUp(a);b.registerRowChangeEvent(a);b.registerRowAutoComplete(a);b.checkDeleteIcon();b.rowsCalculations();b.updateRowSequence()},registerChangeQtyparam:function(a){a.on("click",".qtyparamButton",function(d){var c=$(d.currentTarget);var f=c.data("rownum");var b=$('input[name="qtyparam'+f+'"]');if(b.is(":checked")){c.removeClass("active");b.prop("checked",false)}else{c.addClass("active");b.prop("checked",true)}})},registerEvents:function(a){this.registerInventorySaveData(a);this.registerAddItem(a);this.initItem();this.registerSortableItems();this.registerSubProducts(a);this.registerChangeDiscount(a);this.registerChangeTax(a);this.registerClearReferenceSelection(a);this.registerShowHideExpanded(a);this.registerChangeCurrency(a);this.registerChangeQtyparam(a)}});jQuery(document).ready(function(){var a=app.getModuleName();var b=a+"_Inventory_Js";if(typeof window[b]=="undefined"){b="Vtiger_Inventory_Js"}if(typeof window[b]!="undefined"){var c=new window[b]();c.registerEvents(Vtiger_Edit_Js.getInstance().getForm())}});