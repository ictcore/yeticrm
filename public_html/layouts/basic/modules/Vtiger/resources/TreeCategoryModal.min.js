jQuery.Class("Vtiger_TreeCategory_Js",{},{modalContainer:false,treeInstance:false,treeData:false,getModalContainer:function(){if(this.modalContainer==false){this.modalContainer=jQuery("#modalTreeCategoryModal")}return this.modalContainer},getRecords:function(b){if(this.treeData==false&&b!="undefined"){var a=b.find("#treePopupValues").val();this.treeData=JSON.parse(a)}return this.treeData},generateTree:function(b){var c=this;if(c.treeInstance==false){c.treeInstance=b.find("#treePopupContents");var a=["search"];if(c.isActiveCategory()){a.push("category")}if(c.getRelationType()=="2"){a.push("checkbox")}if(c.getRelationType()=="1"){a.push("edit")}c.treeInstance.jstree({core:{data:c.getRecords(),themes:{name:"proton",responsive:true}},plugins:a})}},isActiveCategory:function(){return this.getModalContainer().find("#isActiveCategory").val()=="1"},getRelationType:function(){return this.getModalContainer().find("#relationType").val()},searching:function(a){this.treeInstance.jstree(true).search(a)},registerSearchEvent:function(){var c=this;var a=$("#valueSearchTree");var b=$("#btnSearchTree");a.keypress(function(d){if(d.which==13){c.searching(a.val())}});b.click(function(){c.searching(a.val())})},registerSaveRecords:function(a){var d=this;var b=[],c=[];$.each(d.getRecords(),function(e,f){if(f.state&&f.state.selected&&f.type=="record"){b.push(f.record_id)}if(f.category&&f.category.checked){c.push(f.record_id)}});a.find('[name="saveButton"]').on("click",function(m){var k=[],f=[],g=[],j=[],h=[],n=[];var l=$(this);l.attr("disabled","disabled");$.each(d.treeInstance.jstree("get_selected",true),function(e,o){if(jQuery.inArray(o.original.record_id,b)==-1&&o.original.type=="record"){g.push(o.original.record_id)}k.push(o.original.record_id)});$.each(b,function(e,o){if(jQuery.inArray(o,k)==-1){j.push(o)}});if(d.isActiveCategory()){f=d.treeInstance.jstree("getCategory");$.each(f,function(e,o){if(jQuery.inArray(o,c)==-1){h.push(o)}});$.each(c,function(e,o){if(jQuery.inArray(o,f)==-1){n.push(o)}})}var i={module:app.getModuleName(),action:"RelationAjax",mode:"updateRelation",recordsToAdd:g,recordsToRemove:j,categoryToAdd:h,categoryToRemove:n,src_record:app.getRecordId(),related_module:a.find("#relatedModule").val(),};if(g.length>4){bootbox.dialog({title:app.vtranslate("JS_INFORMATION"),message:app.vtranslate("JS_SAVE_SELECTED_ITEMS_ALERT").replace("__LENGTH__",g.length),buttons:{success:{label:app.vtranslate("JS_LBL_SAVE"),className:"btn-success",callback:function(){d.saveRecordsEvent(i)}},danger:{label:app.vtranslate("JS_LBL_CANCEL"),className:"btn-warning",callback:function(){l.removeAttr("disabled")}}}})}else{d.saveRecordsEvent(i)}})},saveRecordsEvent:function(a){AppConnector.request(a).then(function(b){Vtiger_Detail_Js.getInstance().reloadTabContent();app.hideModalWindow()})},registerCounterSelected:function(){var a=this;this.treeInstance.on("changed.jstree",function(f,c){var d=0;var b="";$.each(a.treeInstance.jstree("get_selected",true),function(e,g){var h=g.original.record_id.toString();if(h.indexOf("T")){d++}});b=app.vtranslate("JS_SELECTED_ELEMENTS")+": "+d;$(".counterSelected").text(b)})},registerEvents:function(){var a=this.getModalContainer();this.getRecords(a);this.generateTree(a);this.registerSaveRecords(a);this.registerSearchEvent();this.registerCounterSelected()}});jQuery(function(){var a=new Vtiger_TreeCategory_Js();a.registerEvents()});