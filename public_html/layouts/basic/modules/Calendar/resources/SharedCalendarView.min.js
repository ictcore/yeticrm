
var multipleEventsToLoad=0;Calendar_CalendarView_Js("SharedCalendar_SharedCalendarView_Js",{currentInstance:false,initiateCalendarFeeds:function(){Calendar_CalendarView_Js.currentInstance.performCalendarFeedIntiate()}},{multipleEvents:{},multipleEventsToCalnedar:[],multipleEventsOnLoad:0,getAllUserColors:function(){var a={};var b=jQuery("[data-calendar-feed]");b.each(function(c,d){var e=jQuery(d);var g=app.cacheGet("calendar.feeds.disabled",[]);if(g.indexOf(e.data("calendar-sourcekey"))==-1){e.prop("checked",true);var f=e.data("calendar-userid");a[f]=e.data("calendar-feed-color")+","+e.data("calendar-feed-textcolor")}});return a},fetchAllCalendarFeeds:function(){var b=this;var a=jQuery("[data-calendar-feed]");var c=jQuery("[data-calendar-feed].checked");multipleEventsToLoad=c.length+1;b.multipleEventsOnLoad=1;a.each(function(d,e){var f=jQuery(e);b.getCalendarView().fullCalendar("removeEventSource",b.calendarfeedDS[f.data("calendar-sourcekey")]);if(f.prop("checked")=="checked"){multipleEventsToLoad=--multipleEventsToLoad;b.fetchCalendarFeed(f)}});this.multipleEvents=false;b.multipleEventsOnLoad=0},fetchCalendarFeed:function(b){var a=this;this.calendarfeedDS[b.data("calendar-sourcekey")]=function(g,c,f){if(typeof a.multipleEvents!="undefined"&&a.multipleEvents!=false){var d=a.multipleEvents[b.data("calendar-userid")];if(d!==false&&multipleEventsToLoad>0){$.merge(a.multipleEventsToCalnedar,d);return}if(a.multipleEventsToCalnedar.length!=0){f(a.multipleEventsToCalnedar);return}else{if(d!==false){f(d);return}}}if(b.not(":checked").length>0){f([]);return}b.attr("disabled",true);var e={module:"Calendar",action:"Feed",start:app.getStringDate(g),end:app.getStringDate(c),type:b.data("calendar-feed"),userid:b.data("calendar-userid"),color:b.data("calendar-feed-color"),textColor:b.data("calendar-feed-textcolor")};AppConnector.request(e).then(function(h){f(h);b.attr("disabled",false).prop("checked",true)},function(h){f([])})};if(a.multipleEventsOnLoad==1){this.getCalendarView().fullCalendar("addEventSource",this.calendarfeedDS[b.data("calendar-sourcekey")])}},allocateColorsForAllUsers:function(){var a=jQuery("[data-calendar-feed]");a.each(function(c,d){var h=jQuery(d);var g=h.closest(".addedCalendars").find(".label");var i=h.data("calendar-sourcekey");var b=h.data("calendar-feed-color");if(b==""||typeof b=="undefined"){b=app.cacheGet(i);if(b==null){b="#"+(16777216+(Math.random())*16777215).toString(16).substr(1,6);app.cacheSet(i,b)}h.data("calendar-feed-color",b);g.css({"background-color":b})}var f=app.getColorContrast(b.slice(1));var e;if(f=="light"){e="black"}else{e="white"}h.data("calendar-feed-textcolor",e);g.css({color:e})})},fetchAllEvents:function(){var b=jQuery.progressIndicator({position:"#calendarview",blockInfo:{enabled:true}});var c=this;var a=this.getAllUserColors();var d={module:"Calendar",action:"Feed",start:app.getStringDate(c.getCalendarView().fullCalendar("getView").visStart),end:app.getStringDate(c.getCalendarView().fullCalendar("getView").visEnd),type:"MultipleEvents",mapping:a};AppConnector.request(d).then(function(e){c.multipleEvents=e;c.fetchAllCalendarFeeds();b.progressIndicator({mode:"hide"})},function(e){})},isAllowedToAddCalendarEvent:function(b){var a=b.assigned_user_id.value;if(jQuery("[data-calendar-userid="+a+"]").is(":checked")){return true}else{return false}},addCalendarEvent:function(a){if(a.activitytype.value=="Task"){var c=app.vtranslate("JS_TASK_IS_SUCCESSFULLY_ADDED_TO_YOUR_CALENDAR");var b={text:c,type:"info"};Vtiger_Helper_Js.showPnotify(b)}else{this._super(a)}},deleteCalendarView:function(c){var a=jQuery.Deferred();var b=this;var d={module:"Calendar",action:"CalendarUserActions",mode:"deleteUserCalendar",userid:c.data("calendar-userid")};AppConnector.request(d).then(function(f){var e=f.result;c.closest(".addedCalendars").remove();b.resetAccordionHeight();b.getCalendarView().fullCalendar("removeEventSource",b.calendarfeedDS[c.data("calendar-sourcekey")]);var h=jQuery("#calendarview-feeds").find('[name="usersCalendarList"]');h.append('<option value="'+e.sharedid+'">'+e.username+"</option>");var g=jQuery("#calendarview-feeds").find('[name="editingUsersList"]');g.find('option[value="'+e.sharedid+'"]').remove();jQuery("#calendarview-feeds").find(".invisibleCalendarViews").val("true");a.resolve()},function(e){a.reject()});return a.promise()},registerEventForEditUserCalendar:function(){var b=this;var a=jQuery("#calendarview-feeds");a.on("click",".editCalendarColor",function(h){h.preventDefault();var g=jQuery(h.currentTarget);var i=g.closest(".addedCalendars");var f=i.find("[data-calendar-feed]");var d=jQuery("#calendarview-feeds").find(".editCalendarViewsList");var c=d.find('[name="editingUsersList"]');c.find("option:selected").removeAttr("selected");c.find('option[value="'+f.data("calendar-userid")+'"]').attr("selected",true);b.showAddUserCalendarModal(g)})},registerViewsListChangeEvent:function(c){var a=jQuery("#calendarview-feeds");var b=c.find('[name="editingUsersList"]');var d=c.find(".selectedUserColor");b.on("change",function(){var e=b.find("option:selected").val();var f=jQuery('[data-calendar-userid="'+e+'"]',a).data("calendar-feed-color");d.val(f);c.find(".calendarColorPicker").ColorPickerSetColor(f)})},saveUserCalendar:function(f,a){var d=this;var c=f.find(".selectedUserColor").val();var b=f.find(".selectedUser").val();var e=f.find(".selectedUser").data("username");var g={module:"Calendar",action:"CalendarUserActions",mode:"addUserCalendar",selectedUser:b,selectedColor:c};AppConnector.request(g).then(function(){app.hideModalWindow();var p=jQuery("#calendarview-feeds");var q=app.getColorContrast(c.slice(1));var o;if(q=="light"){o="black"}else{o="white"}var k,r;if(f.find(".userCalendarMode").val()=="edit"){k=jQuery('[data-calendar-userid="'+b+'"]',p);k.data("calendar-feed-color",c).data("calendar-feed-textcolor",o);k.closest(".addedCalendars").find(".label").css({"background-color":c,color:o});d.getCalendarView().fullCalendar("removeEventSource",d.calendarfeedDS[k.data("calendar-sourcekey")]);d.fetchCalendarFeed(k);r=app.vtranslate("JS_CALENDAR_VIEW_COLOR_UPDATED_SUCCESSFULLY")}else{var j=jQuery(".labelModal",p);var n=j.clone(true,true);var h=n.find("label");k=h.find('[type="checkbox"]');k.prop("checked",true);k.attr("data-calendar-feed-color",c).attr("data-calendar-feed","Events").attr("data-calendar-userid",b).attr("data-calendar-sourcekey","Events33_"+b).attr("data-calendar-feed-textcolor",o);k.closest(".addedCalendars").find(".label").css({"background-color":c,color:o}).text(e);p.append(h);d.resetAccordionHeight();d.fetchCalendarFeed(k);var m=jQuery("#calendarview-feeds").find('[name="usersCalendarList"]');m.find('option[value="'+b+'"]').remove();if(m.find("option").length<=0){jQuery("#calendarview-feeds").find(".invisibleCalendarViews").val("false")}var l=jQuery("#calendarview-feeds").find('[name="editingUsersList"]');l.append('<option value="'+b+'">'+e+"</option>");r=app.vtranslate("JS_CALENDAR_VIEW_ADDED_SUCCESSFULLY")}var i={text:r,type:"info"};Vtiger_Helper_Js.showPnotify(i)},function(h){})},performCalendarFeedIntiate:function(){this.allocateColorsForAllUsers();this.fetchAllEvents();this.registerCalendarFeedChange();this.registerEventForDeleteUserCalendar();this.registerEventForEditUserCalendar();this.resetAccordionHeight()},registerCalendarFeedChange:function(){var a=this;jQuery("#calendarview-feeds").on("change","[data-calendar-feed]",function(f){var b=jQuery.progressIndicator({position:"#calendarview",blockInfo:{enabled:true}});var d=$(f.currentTarget);var c=d.data("calendar-sourcekey");var g;if(d.is(":checked")){g=app.cacheGet("calendar.feeds.disabled",[]);g=jQuery.grep(g,function(e){return e!=c});app.cacheSet("calendar.feeds.disabled",g);if(!a.calendarfeedDS[c]){a.fetchCalendarFeed(d)}a.getCalendarView().fullCalendar("addEventSource",a.calendarfeedDS[c])}else{g=app.cacheGet("calendar.feeds.disabled",[]);if(g.indexOf(c)==-1){g.push(c)}app.cacheSet("calendar.feeds.disabled",g);a.getCalendarView().fullCalendar("removeEventSource",a.calendarfeedDS[c])}b.progressIndicator({mode:"hide"})})},restoreAddCalendarWidgetState:function(){var a="Calendar_sideBar_LBL_ADDED_CALENDARS";var c=app.cacheGet(a);var b=jQuery("#Calendar_sideBar_LBL_ADDED_CALENDARS");if(c==0){Vtiger_Index_Js.loadWidgets(b,false)}else{Vtiger_Index_Js.loadWidgets(b)}},registerEvents:function(){this._super();this.restoreAddCalendarWidgetState();return this}});