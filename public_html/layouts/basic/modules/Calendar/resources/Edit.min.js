
Vtiger_Edit_Js("Calendar_Edit_Js",{},{isEvents:function(){var b=this.getForm();var a=b.find('[name="module"]').val();if(a=="Events"){return true}return false},registerReminderFieldCheckBox:function(){this.getForm().find('input[name="set_reminder"]').on("change",function(c){var b=jQuery(c.currentTarget);var a=b.closest("div").next();if(b.is(":checked")){a.removeClass("hide")}else{a.addClass("hide")}})},registerRecurrenceFieldCheckBox:function(){var c=this;var b=c.getForm();b.find('input[name="reapeat"]').on("change",function(h){var g=jQuery(h.currentTarget);var f=b.find(".repeatUI");var d=b.find('[name="followup"]').closest(".fieldValue");if(g.is(":checked")){f.removeClass("hide");d.find('[name="followup_display"]').attr("disabled","disabled");d.find("button").attr("disabled","disabled")}else{d.find('[name="followup_display"]').removeAttr("disabled");d.find("button").removeAttr("disabled");f.addClass("hide")}});if(b.find('input[name="reapeat"]').is(":checked")){b.find(".repeatUI").removeClass("hide");var a=b.find('[name="followup"]').closest(".fieldValue");a.find('[name="followup_display"]').attr("disabled","disabled");a.find("button").attr("disabled","disabled")}},registerRecurringTypeChangeEvent:function(){var a=this.getForm();var b=this;a.find(".recurringType").on("change",function(f){var d=jQuery(f.currentTarget);var c=d.val();b.changeRecurringTypesUIStyles(c)});a.find('.repeatUI [name="calendarEndType"]').on("change",function(f){var d=$(f.currentTarget);var c=d.val();if(c==="never"){a.find(".countEvents").attr("disabled","disabled");a.find(".calendarUntil").attr("disabled","disabled")}else{if(c==="count"){a.find(".countEvents").removeAttr("disabled");a.find(".calendarUntil").attr("disabled","disabled")}else{if(c==="until"){a.find(".countEvents").attr("disabled","disabled");a.find(".calendarUntil").removeAttr("disabled")}}}})},changeRecurringTypesUIStyles:function(b){var a=this.getForm();if(b=="DAILY"||b=="YEARLY"){a.find(".repeatWeekUI").removeClass("show").addClass("hide");a.find(".repeatMonthUI").removeClass("show").addClass("hide")}else{if(b=="WEEKLY"){a.find(".repeatWeekUI").removeClass("hide").addClass("show");a.find(".repeatMonthUI").removeClass("show").addClass("hide")}else{if(b=="MONTHLY"){a.find(".repeatWeekUI").removeClass("show").addClass("hide");a.find(".repeatMonthUI").removeClass("hide").addClass("show")}}}},setDefaultEndTime:function(c){var g=c.find('[name="date_start"]');var i=c.find('[name="time_start"]');var f=c.find('[name="time_end"]');var b=c.find('[name="due_date"]');if(jQuery('[name="userChangedEndDateTime"]').val()=="1"){return}var e=g.val();var d=i.val();var m=Vtiger_Time_Validator_Js.invokeValidation(i);if(m!=true){return}var l=e+" "+d;var a=c.find('[name="due_date"]').data("dateFormat");var h=f.data("format");var j="";if(c.find('[name="activitytype"]').val()=="Call"){j=moment(l).add(c.find('[name="defaultCallDuration"]').val(),"minutes").format(a.toUpperCase())}else{j=moment(l).add(c.find('[name="defaultOtherEventDuration"]').val(),"minutes").format(a.toUpperCase())}if(h==24){var k="HH:mm"}else{k="hh:mm tt"}b.val(j);f.val(moment(l).format(k))},registerActivityTypeChangeEvent:function(a){var b=this;a.on("change",'select[name="activitytype"]',function(c){b.setDefaultEndTime(a)})},registerTimeStartChangeEvent:function(a){var b=this;a.find('input[name="time_start"]').on("change",function(c){b.setDefaultEndTime(a)});a.find('[name="date_start"]').on("change",function(h){var j=jQuery(h.currentTarget);var g=a.find('[name="due_date"]');var i=b.getDateInstance(a,"start");var d=b.getDateInstance(a,"end");var c=$("#userDateFormat").val().toUpperCase();a.find(".autofill:visible").trigger("change");if(i>d){d=i;g.val(moment(d).format(c));app.registerEventForDatePickerFields(a);b.setVisibilityBtnSaveAndClose(a)}var f=j.closest(".fieldValue").find('[name="time_start"]');f.trigger("changeTime")});a.find('input[name="time_start"]').on("focus",function(d){var c=jQuery(d.currentTarget);c.data("prevValue",c.val())});a.find('input[name="time_start"]').on("blur",function(i,g){if(typeof g=="undefined"){g={}}if(typeof g.forceChange=="undefined"){g.forceChange=false}var c=jQuery(i.currentTarget);var d=c.val();var h=c.data("prevValue");if(d!=h||g.forceChange){var f=c.data("timepicker-list");if(!f){c.timepicker("show");c.timepicker("hide");f=c.data("timepicker-list")}i=jQuery.Event("keydown");i.which=13;i.keyCode=13;c.trigger(i)}})},setVisibilityBtnSaveAndClose:function(a){var d=a.find('input[name="due_date"]');var f=d.data("date-format");var g=d.val();var c=a.find('input[name="time_end"]');var e=c.val();var i=g+" "+e;var h=Vtiger_Helper_Js.getDateInstance(i,f);var b=h-new Date();if(b>=0){a.find(".saveAndComplete").addClass("hide")}else{a.find(".saveAndComplete").removeClass("hide")}},registerEndDateTimeChangeLogger:function(a){var b=this;a.find('[name="time_end"]').on("change",function(g){var f=jQuery(g.currentTarget);var c=Vtiger_Time_Validator_Js.invokeValidation(f);if(c!=true){return}var d=f.closest(".fieldValue").find('[name="due_date"]');jQuery('[name="userChangedEndDateTime"]').val("1");d.data("userChangedTime",true)});a.find('[name="due_date"]').on("change",function(f){var d=jQuery(f.currentTarget);var c=Vtiger_Date_Validator_Js.invokeValidation(d);if(c!=true){return}b.setVisibilityBtnSaveAndClose(a);jQuery('[name="userChangedEndDateTime"]').val("1");d.data("userChangedTime",true)})},getRule:function(){var c=this.getForm();var b=c.find(".recurringType").val();var h="FREQ="+b;h+=";INTERVAL="+c.find(".repeatFrequency").val();var i=c.find('.repeatUI [name="calendarEndType"]:checked').val();if(i==="count"){h+=";COUNT="+c.find(".countEvents").val()}else{if(i==="until"){var d=c.find(".calendarUntil").val();d=app.getDateInDBInsertFormat(app.getMainParams("userDateFormat"),d);h+=";UNTIL="+d.replace(/-/gi,"")+"T000000"}}if(b==="WEEKLY"){var f=[];c.find('.repeatWeekUI [type="checkbox"]').each(function(){var l=$(this);if(l.is(":checked")){f.push(l.val())}});if(f.length>0){h+=";BYDAY="+f.join(",")}}if(b==="MONTHLY"){var e=Vtiger_Helper_Js.getDay(c.find('[name="date_start"]').val());var a=Vtiger_Helper_Js.getDateInstance(c.find('[name="date_start"]').val(),app.getMainParams("userDateFormat"));var j=a.getDate();var g=c.find(".calendarMontlyType:checked").val();if(g=="DAY"){var k="";switch(e){case 0:k="SU";break;case 1:k="MO";break;case 2:k="TU";break;case 3:k="WE";break;case 4:k="TU";break;case 5:k="FR";break;case 6:k="SA";break}h+=";BYDAY="+(parseInt((j-1)/7)+1)+k}else{h+=";BYMONTHDAY="+j}}return h},registerFormSubmitEvent:function(){var c=this;var b=this.getForm();var a=true;if(app.getRecordId()){b.on(Vtiger_Edit_Js.recordPreSave,function(d){if(a&&b.find('input[name="reapeat"]').is(":checked")){d.preventDefault();app.showModalWindow(b.find(".typeSavingModal").clone(),function(e){e.find(".typeSavingBtn").click(function(g){var f=$(g.currentTarget);b.find('[name="typeSaving"]').val(f.data("value"));app.hideModalWindow();a=false;b.submit()})})}})}b.on("submit",function(f){var h=b.find('input[name="reapeat"]').is(":checked");if(h){if(app.getRecordId()&&a){f.preventDefault()}b.find('[name="recurrence"]').val(c.getRule())}if(c.isEvents()){var d=b.find(".inviteesContent .inviteRow");var g=[];d.each(function(e,j){var i=jQuery(j);if(i.data("crmid")!=""){g.push([i.data("email"),i.data("crmid"),i.data("ivid")])}});jQuery('<input type="hidden" name="inviteesid" />').appendTo(b).val(JSON.stringify(g))}})},getFreeTime:function(b){var d=b.find('[name="time_start"], [data-element-name="time_start"]');var a=b.find('[name="time_end"], [data-element-name="time_end"]');var c=b.find('[name="date_start"], [data-element-name="date_start"]');var e={module:"Calendar",action:"GetFreeTime",dateStart:c.val()};b.progressIndicator({});AppConnector.request(e).then(function(f){b.progressIndicator({mode:"hide"});d.val(f.result.time_start);a.val(f.result.time_end);c.val(f.result.date_start);b.find('[name="due_date"]').val(f.result.date_start)})},registerAutoFillHours:function(b){var d=this;var e=b.find('[name="allday"]');var f=b.find('[name="time_start"]');var a=b.find('[name="time_end"]');var c=b.find('[name="due_date"]');b.find(".autofill").on("change",function(h){var g=$(h.currentTarget);if(g.is(":checked")){b.find(".autofill").prop("checked",true);d.getFreeTime(b);f.attr("readonly","readonly");a.attr("readonly","readonly");e.attr("disabled","disabled");e.prop("checked",false);e.trigger("change");c.attr("readonly","readonly")}else{b.find(".autofill").prop("checked",false);e.removeAttr("disabled");f.removeAttr("readonly");a.removeAttr("readonly");c.removeAttr("readonly")}})},registerSaveAndCloseBtn:function(a){this.setVisibilityBtnSaveAndClose(a);a.find(".saveAndComplete").on("click",function(){var b=a.data("jqv").InvalidFields;if(b.length==0){a.append('<input type=hidden name="saveAndClose" value="PLL_COMPLETED">')}a.find('[type="submit"]').trigger("click")})},registerBasicEvents:function(a){this._super(a);this.toggleTimesInputs(a);this.registerTimesInputs(a);this.registerTimeStartChangeEvent(a);this.registerActivityTypeChangeEvent(a);this.registerEndDateTimeChangeLogger(a);this.registerAutoFillHours(a);this.registerSaveAndCloseBtn(a)},toggleTimesInputs:function(a){a.find(":checkbox").change(function(){var b=$(this).attr("name");if("allday"==b){var c=$(this).is(":checked");if(!a.find("#quickCreate").length){if(c){a.find(".time").hide()}else{a.find(".time").show()}}}})},registerTimesInputs:function(b){var a=b.find('[name="allday"]:checkbox');if(a.prop("checked")){b.find(".time").hide()}},getDateInstance:function(c,k){var j=c.find('[name="date_start"]');var b=c.find('[name="due_date"]');var f=c.find('[name="time_end"]');var g=c.find('[name="time_start"]');var e=j.val();var d=g.val();var i=f.val();var h=b.val();var a=$("#userDateFormat").val();if(k=="start"){return Vtiger_Helper_Js.getDateInstance(e+" "+d,a)}if(k=="end"){return Vtiger_Helper_Js.getDateInstance(h+" "+i,a)}},registerInviteEvent:function(d){var c=this;this.registerRow(d);var a=d.find(".inviteesContent");var b=d.find("input.inviteesSearch");$.widget("custom.ivAutocomplete",$.ui.autocomplete,{_create:function(){this._super();this.widget().menu("option","items","> :not(.ui-autocomplete-category)")},_renderMenu:function(g,f){var h=this,e="";$.each(f,function(j,k){var i;if(k.category!=e){g.append("<li class='ui-autocomplete-category'>"+k.category+"</li>");e=k.category}h._renderItemData(g,k)})},_renderItemData:function(e,f){return this._renderItem(e,f).data("ui-autocomplete-item",f)},_renderItem:function(e,f){return $("<li>").data("item.autocomplete",f).append($("<a></a>").html(f.label)).appendTo(e)},});b.ivAutocomplete({delay:"600",minLength:"3",source:function(f,e){AppConnector.request({module:"Calendar",action:"Invitees",mode:"find",value:f.term}).then(function(g){var h=g.result;if(h.length<=0){h.push({label:app.vtranslate("JS_NO_RESULTS_FOUND"),type:"no results",category:""})}e(h)})},select:function(g,h){var f=h.item;if(typeof f.type!="undefined"&&f.type=="no results"){return false}var e=true;a.find(".inviteRow").each(function(j){if($(this).data("crmid")==f.id){e=false}});if(e){var i=a.find(".hide .inviteRow").clone(true,true);Vtiger_Index_Js.getEmailFromRecord(f.id,f.module).then(function(j){i.data("crmid",f.id);i.data("email",j);i.find(".inviteName").data("content",f.fullLabel+j).text(f.label);i.find(".inviteIcon .glyphicon").removeClass("glyphicon glyphicon-envelope").addClass("userIcon-"+f.module);a.append(i)})}},close:function(e,f){b.val("")}})},registerRow:function(b){var a=this;b.on("click",".inviteRemove",function(c){$(c.target).closest(".inviteRow").remove()})},registerEvents:function(){var a=this.proceedRegisterEvents();if(!a){return}var b=this.getForm();this.registerReminderFieldCheckBox();this.registerRecurrenceFieldCheckBox();this.registerFormSubmitEvent();this.registerRecurringTypeChangeEvent();if(this.isEvents()){this.registerInviteEvent(b)}this._super()}});