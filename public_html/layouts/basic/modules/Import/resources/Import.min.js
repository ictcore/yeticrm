
if(typeof(ImportJs)=="undefined"){ImportJs={toogleMergeConfiguration:function(){var a=jQuery("#auto_merge").is(":checked");var b=jQuery("#duplicates_merge_configuration");if(a){b.show()}else{b.hide()}},checkFileType:function(){var a=jQuery("#import_file").val();if(a!=""){var b=a.split(".").pop();jQuery("#type").val(b);ImportJs.handleFileTypeChange()}},handleFileTypeChange:function(){var a=jQuery("#type").val();var c=jQuery("#delimiter_container");var d=jQuery("#has_header_container");var b=jQuery("#xml_tpl");var e=jQuery("#zipExtension");switch(a){case"xml":c.hide();d.hide();b.removeClass("hide");e.addClass("hide");break;case"zip":c.hide();d.hide();e.removeClass("hide");break;default:c.show();d.show();e.addClass("hide");b.addClass("hide")}},uploadAndParse:function(){if(!ImportJs.validateFilePath()){return false}if(!ImportJs.validateMergeCriteria()){return false}return true},registerImportClickEvent:function(){jQuery("#importButton").on("click",function(b){var a=ImportJs.sanitizeAndSubmit();return a})},validateFilePath:function(){var d=jQuery("#import_file");var b=d.val();if(jQuery.trim(b)==""){var a=app.vtranslate("JS_IMPORT_FILE_CAN_NOT_BE_EMPTY");var c={text:a,type:"error"};Vtiger_Helper_Js.showMessage(c);d.focus();return false}if(!ImportJs.uploadFilter("import_file","csv|vcf|xml|zip")){return false}if(!ImportJs.uploadFileSize("import_file")){return false}return true},uploadFilter:function(f,b){var e=jQuery("#"+f);if(e){var c=e.val();var a=c.toLowerCase().split(".");var k=a[a.length-1];var h=b.toLowerCase().split("|");if(h.indexOf(k)<0){var g=app.vtranslate("JS_SELECT_FILE_EXTENSION")+"\n"+h;var d={text:g,type:"error"};Vtiger_Helper_Js.showMessage(d);e.focus();return false}}return true},uploadFileSize:function(b){var d=jQuery("#"+b);var e=d.closest("td").data("importUploadSize");var a=d.closest("td").data("importUploadSizeMb");var g=d.get(0).files[0].size;if(g>e){var c=app.vtranslate("JS_UPLOADED_FILE_SIZE_EXCEEDS")+" "+a+" MB."+app.vtranslate("JS_PLEASE_SPLIT_FILE_AND_IMPORT_AGAIN");var f={text:c,type:"error"};Vtiger_Helper_Js.showMessage(f);return false}return true},validateMergeCriteria:function(){$mergeChecked=jQuery("#auto_merge").is(":checked");if($mergeChecked){var c=jQuery("#selected_merge_fields option");if(c.length==0){var a=app.vtranslate("JS_PLEASE_SELECT_ONE_FIELD_FOR_MERGE");var b={text:a,type:"error"};Vtiger_Helper_Js.showMessage(b);return false}}ImportJs.convertOptionsToJSONArray("#selected_merge_fields","#merge_fields");return true},convertOptionsToJSONArray:function(d,c){var e=jQuery(d);var a=[];if(typeof(e)!="undefined"&&e[0]!=""){for(i=0;i<e[0].length;++i){a.push(e[0].options[i].value)}}if(c!="undefined"){var b=$(c);if(typeof(b)!="undefined"){b.val(JSON.stringify(a))}}return a},copySelectedOptions:function(g,a){var d=jQuery(g);var b=jQuery(a);if(typeof(d)=="undefined"||typeof(b)=="undefined"){return}for(i=0;i<d[0].length;i++){if(d[0].options[i].selected==true){var c=false;var f=null;for(j=0;j<b[0].length;j++){if(b[0].options[j].value==d[0].options[i].value){c=true;f=b[0].options[j];break}}if(c!=true){var e=$("<option selected>");e.attr("value",d[0].options[i].value);e.text(d[0].options[i].text);jQuery(b[0]).append(e);d[0].options[i].selected=false;c=false}else{if(f!=null){f.selected=true}}}}},removeSelectedOptions:function(a){var b=jQuery(a);if(b==null||typeof(b)=="undefined"){return}for(i=b[0].options.length-1;i>=0;i--){if(b[0].options[i].selected==true){b[0].options[i]=null}}},sanitizeAndSubmit:function(){if(!ImportJs.sanitizeFieldMapping()){return false}if(!ImportJs.validateCustomMap()){return false}return true},sanitizeFieldMapping:function(){var h=jQuery(".fieldIdentifier");var c={};var f={};var s;var u={};var m={};for(var t=0;t<h.length;++t){var b=jQuery(h.get(t));var g=jQuery("[name=row_counter]",b).get(0).value;var n=jQuery("select",b);var q=n.find("option:selected");var k=q.val();var e=jQuery("#"+k+"_defaultvalue",b);var r="";if(e.attr("type")=="checkbox"){r=e.is(":checked")}else{r=e.val()}if(k!=""){var d;if(n.hasClass("inventory")){d=ImportJs.checkIfMappedFieldExist(k,f,q);f[k]=g-1}else{d=ImportJs.checkIfMappedFieldExist(k,c,q);c[k]=g-1}if(d){return false}if(r!=""){m[k]=r}}}var o=JSON.parse(jQuery("#mandatory_fields").val());var p=app.getModuleName();var a=[];for(var l in o){if(l in c){continue}else{a.push('"'+o[l]+'"')}}if(a.length>0){s=app.vtranslate("JS_MAP_MANDATORY_FIELDS")+a.join(",");u={text:s,type:"error"};Vtiger_Helper_Js.showMessage(u);return false}jQuery("#field_mapping").val(JSON.stringify(c));jQuery("#inventory_field_mapping").val(JSON.stringify(f));jQuery("#default_values").val(JSON.stringify(m));return true},checkIfMappedFieldExist:function(b,c,d){if(b in c){var a=app.vtranslate("JS_FIELD_MAPPED_MORE_THAN_ONCE")+" "+d.data("label");var e={text:a,type:"error"};Vtiger_Helper_Js.showMessage(e);return true}return false},validateCustomMap:function(){var d;var g={};var b=jQuery("#save_map").is(":checked");if(b){var f=jQuery("#save_map_as").val();if(jQuery.trim(f)==""){d=app.vtranslate("JS_MAP_NAME_CAN_NOT_BE_EMPTY");g={text:d,type:"error"};Vtiger_Helper_Js.showMessage(g);return false}var c=jQuery("#saved_maps option");for(var e=0;e<c.length;++e){var a=jQuery(c.get(e));if(a.html()==f){d=app.vtranslate("JS_MAP_NAME_ALREADY_EXISTS");g={text:d,type:"error"};Vtiger_Helper_Js.showMessage(g);return false}}}return true},loadSavedMap:function(){var d=jQuery("#saved_maps option:selected");var l=d.attr("id");var h=jQuery(".fieldIdentifier");var a=jQuery("#delete_map_container");h.each(function(n,m){var o=jQuery(m);jQuery("[name=mapped_fields]",o).val("")});if(l==-1){a.hide();return}a.show();var b=d.val();if(b==""){return}var k=b.split("&");var c={};for(var f=0;f<k.length;++f){var e=k[f].split("=");var g=e[0];g=g.replace(/\/eq\//g,"=");g=g.replace(/\/amp\//g,"&");c["'"+g+"'"]=e[1]}h.each(function(o,n){var p=jQuery(n);var q=jQuery("[name=mapped_fields]",p);var r=jQuery("[name=row_counter]",p).get(0).value;var m=jQuery("[name=header_name]",p).get(0);var s=jQuery(m).html();if("'"+s+"'" in c){q.val(c["'"+s+"'"])}else{if(r in c){q.val($rowId)}}q.trigger("chosen:updated");ImportJs.loadDefaultValueWidget(p.attr("id"))})},deleteMap:function(e){if(confirm(app.vtranslate("LBL_DELETE_CONFIRMATION"))){var d=jQuery("#saved_maps option:selected");var c=d.attr("id");var b=jQuery("#status");b.show();var a={module:e,view:"Import",mode:"deleteMap",mapid:c};AppConnector.request(a).then(function(g){jQuery("#savedMapsContainer").html(g);b.hide();var f=jQuery("#saved_maps");app.changeSelectElementView(f)},function(f,g){})}},loadDefaultValueWidget:function(k){var a=jQuery("#"+k);if(typeof a=="undefined"||a==null){return}var f=jQuery("[name=mapped_fields]",a).get(0);var d=jQuery(f).val();var b=jQuery(jQuery("[name=default_value_container]",a).get(0));var e=jQuery("#defaultValuesElementsContainer");if(b.children.length>0){var c=jQuery(":first",b).detach();c.appendTo(e)}var g=jQuery("#"+d+"_defaultvalue_container",e);var h=g.detach();h.appendTo(b)},loadDefaultValueWidgetForMappedFields:function(){var a=jQuery(".fieldIdentifier");a.each(function(c,b){var e=jQuery(b);var d=jQuery("[name=mapped_fields]",e).val();if(d!=""){ImportJs.loadDefaultValueWidget(e.attr("id"))}})},submitAction:function(){var a=jQuery('[name="importAdvanced"]');a.on("submit",function(){var b=jQuery.progressIndicator({message:app.vtranslate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:true}})})}};jQuery(document).ready(function(){ImportJs.toogleMergeConfiguration();ImportJs.submitAction();ImportJs.loadDefaultValueWidgetForMappedFields();ImportJs.registerImportClickEvent();app.registerEventForDatePickerFields(jQuery(".contentsDiv"))})};