
Vtiger_Edit_Js("Products_Edit_Js",{},{baseCurrency:"",baseCurrencyName:"",multiCurrencyContainer:false,unitPrice:false,getUnitPrice:function(){if(this.unitPrice==false){this.unitPrice=jQuery("input.unitPrice",this.getForm())}return this.unitPrice},getMoreCurrenciesContainer:function(){if(this.multiCurrencyContainer==false){this.multiCurrencyContainer=jQuery(".multiCurrencyEditUI")}return this.multiCurrencyContainer},alignBelowUnitPrice:function(b){var a=jQuery('input[name="unit_price"]',this.getForm());b.position({of:a,my:"left top",at:"left bottom",collision:"flip"});return this},getCurrentElem:function(a){return jQuery(a.currentTarget)},registerEventForTaxes:function(){var a=this;var b=this.getForm();jQuery(".taxes").on("change",function(f){var d=a.getCurrentElem(f);var c=d.data("taxName");if(d.is(":checked")){jQuery("input[name="+c+"]",b).removeAttr("readonly")}else{jQuery("input[name="+c+"]",b).attr("readonly","readonly")}});return this},registerEventForEnableBaseCurrency:function(){var a=this.getMoreCurrenciesContainer();var b=this;jQuery(a).on("change",".baseCurrency",function(g){var f=b.getCurrentElem(g);var c=f.closest("tr");if(f.is(":checked")){var d=jQuery(".convertedPrice",c).val();b.baseCurrencyName=c.data("currencyId");b.baseCurrency=d}});return this},registerEventForResetCurrency:function(){var a=this.getMoreCurrenciesContainer();var b=this;jQuery(a).on("click",".currencyReset",function(j){var c=b.getCurrentElem(j).closest("tr");var g=b.getUnitPrice().data();var i=b.getDataBaseFormatUnitPrice();var f=jQuery(".conversionRate",c).val();var h=parseFloat(i)*parseFloat(f);var d=app.parseNumberToShow(h);jQuery(".convertedPrice",c).val(d)});return this},getDataBaseFormatUnitPrice:function(){var b=this.getUnitPrice();var a=b.getNumberFromValue();return a},calculateConversionRate:function(){var b=this.getMoreCurrenciesContainer();var c=b.find(".baseCurrency").filter(":checked").closest("tr");var d=c.find(".conversionRate");if(d.val()=="1"){return}var a=d.val();b.find(".conversionRate").each(function(f,h){var e=jQuery(h);if(!e.is(d)){var g=e.val();e.val((g/a))}});d.val("1")},registerEventForEnableCurrency:function(){var a=this.getMoreCurrenciesContainer();var b=this;jQuery(a).on("change",".enableCurrency",function(i){var c=b.getCurrentElem(i);var m=c.closest("tr");if(c.is(":checked")){c.attr("checked","checked");var j=jQuery(".conversionRate",m).val();var h=b.getUnitPrice().data();var k=b.getDataBaseFormatUnitPrice();var g=parseFloat(k)*parseFloat(j);jQuery("input",m).attr("disabled",true).removeAttr("disabled");jQuery("button.currencyReset",m).attr("disabled",true).removeAttr("disabled");var f=app.parseNumberToShow(g);jQuery("input.convertedPrice",m).val(f)}else{var l=jQuery(".baseCurrency",m);if(l.is(":checked")){var n=jQuery(".currencyName",m).text();var d={type:"error",title:app.vtranslate("JS_ERROR"),text:app.vtranslate("JS_BASE_CURRENCY_CHANGED_TO_DISABLE_CURRENCY")+'"'+n+'"'};Vtiger_Helper_Js.showPnotify(d);c.prop("checked",true);return}jQuery("input",m).attr("disabled",true);jQuery("input.enableCurrency",m).removeAttr("disabled");jQuery("button.currencyReset",m).attr("disabled","disabled")}});return this},getMoreCurrenciesUI:function(){var b=jQuery.Deferred();var d=app.getModuleName();var g=jQuery('input[name="base_currency"]').val();var e=jQuery('input[name="record"]').val();var c=jQuery("#moreCurrenciesContainer");f=c.find(".multiCurrencyEditUI");var f;if(f.length==0){var a={module:d,view:"MoreCurrenciesList",currency:g,record:e};AppConnector.request(a).then(function(h){c.html(h);b.resolve(h)},function(i,h){b.reject(i,h)})}else{b.resolve()}return b.promise()},registerEventForMoreCurrencies:function(){var b=this;var a=this.getForm();jQuery("#moreCurrencies").on("click",function(d){var c=jQuery.progressIndicator();b.getMoreCurrenciesUI().then(function(j){var g;g=jQuery("#moreCurrenciesContainer").find(".multiCurrencyEditUI");if(g.length>0){g=g.clone(true,true);c.hide();var f={"text-align":"left",width:"65%"};var l=function(o){var p=app.validationEngineOptionsForRecord;var n=o.find("#currencyContainer");p.onValidationComplete=function(r,q){if(q){b.saveCurrencies()}return false};n.validationEngine(p);app.showScrollBar(o.find(".currencyContent"),{height:"400px"});b.baseCurrency=b.getUnitPrice().val();var m=jQuery(".multiCurrencyEditUI");b.multiCurrencyContainer=m;b.calculateConversionRate();b.registerEventForEnableCurrency();b.registerEventForEnableBaseCurrency();b.registerEventForResetCurrency();b.triggerForBaseCurrencyCalc()};var e=jQuery("#moreCurrenciesContainer").find(".multiCurrencyEditUI");var i=g.find(".multiCurrencyContainer").html();g.find(".multiCurrencyContainer").remove();var h='<form id="currencyContainer"></form>';jQuery(h).insertAfter(g.find(".modal-header"));g.find("form").html(i);e.find("input[name^=curname]").each(function(n,o){var p=jQuery(o).val();var m=jQuery(o).attr("id");g.find("#"+m).val(p)});var k={data:g,css:f,cb:l};app.showModalWindow(k)}})})},triggerForBaseCurrencyCalc:function(){var a=this.getMoreCurrenciesContainer();var b=a.find(".enableCurrency");jQuery.each(b,function(c,e){if(jQuery(e).is(":checked")){var d=jQuery(e).closest("tr");if(parseFloat(d.find(".convertedPrice").val())==0){d.find(".currencyReset").trigger("click")}}else{jQuery(e).closest("tr").find(".convertedPrice").val("")}})},registerEventForUnitPrice:function(){var a=this;var b=this.getUnitPrice();b.on("change",function(){a.triggerForBaseCurrencyCalc()})},registerRecordPreSaveEvent:function(b){var a=this;if(typeof b=="undefined"){b=this.getForm()}b.on(Vtiger_Edit_Js.recordPreSave,function(g,f){var c=jQuery("#moreCurrenciesContainer").find(".currencyContent");var d=a.getUnitPrice();if((c.length<1)&&(d.length>0)){g.preventDefault();a.getMoreCurrenciesUI().then(function(e){a.preSaveConfigOfForm(b);InitialFormData=b.serialize();b.submit()})}else{if(c.length>0){a.preSaveConfigOfForm(b)}}})},preSaveConfigOfForm:function(b){var c=this.getUnitPrice();if(c.length>0){var a=c.val();var d=b.find('[name="base_currency"]').val();b.find('[name="'+d+'"]').val(a);b.find("#requstedUnitPrice").attr("name",d).val(a)}},saveCurrencies:function(){var l=this;var h,e;var c=jQuery("#currencyContainer");var b=l.getForm();var g=jQuery("#globalmodal");var a=g.find(".enableCurrency").filter(":checked");if(a.length<1){h=app.vtranslate("JS_PLEASE_SELECT_BASE_CURRENCY_FOR_PRODUCT");e={text:h,type:"error"};Vtiger_Helper_Js.showMessage(e);c.removeData("submit");return}a.attr("checked","checked");g.find(".enableCurrency").filter(":not(:checked)").removeAttr("checked");var d=g.find(".baseCurrency").filter(":checked");if(d.length<1){h=app.vtranslate("JS_PLEASE_ENABLE_BASE_CURRENCY_FOR_PRODUCT");e={text:h,type:"error"};Vtiger_Helper_Js.showMessage(e);c.removeData("submit");return}d.attr("checked","checked");g.find(".baseCurrency").filter(":not(:checked)").removeAttr("checked");var f=d.closest("tr");var k=jQuery(".convertedPrice",f).val();l.baseCurrencyName=f.data("currencyId");l.baseCurrency=k;l.getUnitPrice().val(l.baseCurrency);jQuery('input[name="base_currency"]',b).val(l.baseCurrencyName);var i=g.find(".currencyContent").html();var j=jQuery("#moreCurrenciesContainer");j.find(".currencyContent").html(i);g.find("input[name^=curname]").each(function(n,o){var p=jQuery(o).val();var m=jQuery(o).attr("id");j.find(".currencyContent").find("#"+m).val(p)});app.hideModalWindow()},registerSubmitEvent:function(){var a=this.getForm();a.submit(function(d){if((a.find('[name="existingImages"]').length>=1)||(a.find('[name="imagename[]"]').length>1)){jQuery.fn.MultiFile.disableEmpty()}if(typeof a.data("submit")!="undefined"){return false}else{var b=jQuery(d.currentTarget).find('[name="module"]').val();if(a.validationEngine("validate")){a.data("submit","true");var c=jQuery.Event(Vtiger_Edit_Js.recordPreSave);a.trigger(c,{value:"edit"});if(c.isDefaultPrevented()){a.removeData("submit");d.preventDefault()}}else{a.removeData("submit");app.formAlignmentAfterValidation(a)}}})},registerEventForUsageunit:function(){this.checkUsageUnit();$('select[name="usageunit"]').on("change",this.checkUsageUnit)},checkUsageUnit:function(){var c=$('select[name="usageunit"]');var a=$('input[name="qty_per_unit"]');var b=c.val();if(b==="pack"){a.prop("disabled",false)}else{a.prop("disabled",true)}},registerEvents:function(){this._super();this.registerEventForMoreCurrencies();this.registerEventForTaxes();this.registerEventForUnitPrice();this.registerRecordPreSaveEvent();this.registerEventForUsageunit()}});