
var Vtiger_PBXManager_Js={registerPBXCall:function(){Vtiger_PBXManager_Js.requestPBXgetCalls()},registerPBXOutboundCall:function(b,a){Vtiger_PBXManager_Js.makeOutboundCall(b,a)},requestPBXgetCalls:function(){var a="index.php?module=PBXManager&action=IncomingCallPoll&mode=searchIncomingCalls";AppConnector.request(a).then(function(c){if(c.success&&c.result){for(i=0;i<c.result.length;i++){var b=c.result[i];if(jQuery("#pbxcall_"+b.pbxmanagerid+"").size()==0){Vtiger_PBXManager_Js.showPBXIncomingCallPopup(b)}else{Vtiger_PBXManager_Js.updatePBXIncomingCallPopup(b)}}}});Vtiger_PBXManager_Js.removeCompletedCallPopup()},showPBXIncomingCallPopup:function(a){var b={title:app.vtranslate("JS_PBX_INCOMING_CALL"),text:'<div class="row pbxcall" id="pbxcall_'+a.pbxmanagerid+'" callid='+a.pbxmanagerid+' style="color:black"><span class="col-md-12" id="caller" value="'+a.customernumber+'">'+app.vtranslate("JS_PBX_CALL_FROM")+" : "+a.customernumber+'</span><span class="hide col-md-12" id="contactsave_'+a.pbxmanagerid+'">\n                        <span><input class="col-md-3" id="email_'+a.pbxmanagerid+'" type="text" placeholder="Enter Email-id"></input>&nbsp;&nbsp;&nbsp;<select class="input-small" id="module_'+a.pbxmanagerid+'" placeholder="Select"><option>Select</option></select><h5 class="alert-danger hide col-md-3" id="alert_msg">'+app.vtranslate("JS_PBX_FILL_ALL_FIELDS")+'</h5>\n                        <button class="btn btn-success pull-right"  id="pbxcontactsave_'+a.pbxmanagerid+'" recordid="'+a.pbxmanagerid+'" type="submit">Save</button>\n                        </span></span><br /><span class="col-md-12" style="display:none" id="answeredby"><i class="icon-headphones"></i>&nbsp;<span id="answeredbyname"></span></span></div>',width:"28%",min_height:"75px",addclass:"vtCall",icon:"vtCall-icon",hide:false,closer:true,type:"info",after_open:function(c){jQuery(c).data("info",a)}};Vtiger_Helper_Js.showPnotify(b);if(a.user){if(a.user!=a.current_user_id){Vtiger_PBXManager_Js.removeCallPopup(a.pbxmanagerid)}}Vtiger_PBXManager_Js.checkIfRelatedModuleRecordExist(a);if(a.answeredby!=null){jQuery("#answeredbyname","#pbxcall_"+a.pbxmanagerid+"").text(a.answeredby);jQuery("#answeredby","#pbxcall_"+a.pbxmanagerid+"").show()}jQuery("#pbxcontactsave_"+a.pbxmanagerid+"").bind("click",function(d){var c=jQuery(d.currentTarget).attr("recordid");if(jQuery("#module_"+c+"").val()=="Select"){jQuery("#alert_msg").show();return false}if(jQuery("#email_"+c+"").val()==""){jQuery("#alert_msg").show();return false}Vtiger_PBXManager_Js.createRecord(d,a);jQuery("#pbxcontactsave_"+a.pbxmanagerid+"").unbind("click")})},createRecord:function(h,b){var a=jQuery(h.currentTarget).attr("recordid");var f=jQuery("#email_"+a+"").val();var d=jQuery("#module_"+a+"").val();var g=jQuery("#caller","#pbxcall_"+a+"").attr("value");var c="index.php?module=PBXManager&action=IncomingCallPoll&mode=createRecord&number="+encodeURIComponent(g)+"&email="+encodeURIComponent(f)+"&callid="+b.sourceuuid+"&modulename="+d;AppConnector.request(c).then(function(e){if(e.success&&e.result){jQuery("#contactsave_"+a+"").hide()}})},checkIfRelatedModuleRecordExist:function(a){switch(a.callername){case null:var b="index.php?module=PBXManager&action=IncomingCallPoll&mode=checkModuleViewPermission&view=EditView";AppConnector.request(b).then(function(h){var j=JSON.parse(h);var g=false;var f=j.result.modules;var e=jQuery("#module_"+a.pbxmanagerid+"");var c;for(var d in f){if(f.hasOwnProperty(d)){if(f[d]){c='<option id="select_'+d+'" value="'+d+'">'+app.vtranslate(d)+"</option>";e.append(c);g=true}}}if(j.success&&g){jQuery("#contactsave_"+a.pbxmanagerid+"").show()}});break;default:jQuery("#caller","#pbxcall_"+a.pbxmanagerid+"").html(app.vtranslate("JS_PBX_CALL_FROM")+' :&nbsp;<a href="index.php?module='+a.customertype+"&view=Detail&record="+a.customer+'">'+a.callername+"</a>");break}},updatePBXIncomingCallPopup:function(a){if(a.answeredby!=null){jQuery("#answeredbyname","#pbxcall_"+a.pbxmanagerid+"").text(a.answeredby);jQuery("#answeredby","#pbxcall_"+a.pbxmanagerid+"").show()}if(a.customer!=null&&a.customer!=""){jQuery("#caller","#pbxcall_"+a.pbxmanagerid+"").html(app.vtranslate("JS_PBX_CALL_FROM")+' :&nbsp;<a href="index.php?module='+a.customertype+"&view=Detail&record="+a.customer+'">'+a.callername+"</a>");jQuery("#contactsave_"+a.pbxmanagerid+"").hide()}if(a.user){if(a.user!=a.current_user_id){Vtiger_PBXManager_Js.removeCallPopup(a.pbxmanagerid)}}},removeCompletedCallPopup:function(){var b=null;var d=jQuery(".pbxcall");for(var c=0;c<d.length;c++){b=d[c].getAttribute("callid");var a="index.php?module=PBXManager&action=IncomingCallPoll&mode=getCallStatus&callid="+encodeURIComponent(b)+"";AppConnector.request(a).then(function(e){if(e.result){if(e.result!="in-progress"&&e.result!="ringing"){Vtiger_PBXManager_Js.removeCallPopup(b)}}})}},removeCallPopup:function(a){jQuery("#pbxcall_"+a+"").parent().parent().parent().remove()},getContentHolder:function(a){if(a=="List"){return jQuery(".listViewContentDiv")}else{return jQuery(".detailViewContainer")}},makeOutboundCall:function(b,a){var c={number:b,record:a,module:"PBXManager",action:"OutgoingCall"};AppConnector.request(c).then(function(d){if(d.result){c={text:app.vtranslate("JS_PBX_OUTGOING_SUCCESS"),type:"info"}}else{c={text:app.vtranslate("JS_PBX_OUTGOING_FAILURE"),type:"error"}}Vtiger_Helper_Js.showPnotify(c)})},registerEvents:function(){var b=this;var a="index.php?module=PBXManager&action=IncomingCallPoll&mode=checkPermissionForPolling";AppConnector.request(a).then(function(c){if(c.result){Vtiger_PBXManager_Js.registerPBXCall();setInterval("Vtiger_PBXManager_Js.registerPBXCall()",3000)}})}};jQuery(document).ready(function(){Vtiger_PBXManager_Js.registerEvents()});